"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BoaviztaCloudOutput = exports.BoaviztaCpuOutput = void 0;
const zod_1 = require("zod");
const validations_1 = require("../../util/validations");
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const base_output_1 = require("./base-output");
const boavizta_api_1 = require("./boavizta-api");
const { InputValidationError, UnsupportedValueError } = errors_1.ERRORS;
const boaviztaAPI = (0, boavizta_api_1.BoaviztaAPI)();
const baseOutput = (0, base_output_1.BoaviztaBaseOutput)();
const BoaviztaCpuOutput = (globalConfig) => {
    const metadata = { kind: 'execute' };
    const componentType = 'cpu';
    /**
     * Calculates the output of the given usage.
     */
    const execute = async (inputs) => {
        const result = [];
        for await (const input of inputs) {
            const safeInput = validateInput(input);
            const metricTypeData = baseOutput.getMetricTypeData(input);
            const metricType = Object.keys(metricTypeData)[0];
            const mergedWithConfig = Object.assign({}, input, safeInput, { [metricType]: metricTypeData[metricType] }, globalConfig);
            const usageResult = await baseOutput.calculateUsagePerInput(mergedWithConfig, fetchData);
            result.push({
                ...input,
                ...usageResult,
            });
        }
        return result;
    };
    /**
     * Fetches data from the Boavizta API for the CPU plugin.
     */
    const fetchData = async (input, usage) => {
        const data = Object.assign({}, input, { usage });
        const verbose = (globalConfig && globalConfig.verbose) || false;
        const response = await boaviztaAPI.fetchCpuOutputData(data, componentType, verbose);
        const result = baseOutput.formatResponse(response);
        const cpuOutputData = {
            'cpu/energy': result.energy,
            'carbon-embodied': result['carbon-embodied'],
        };
        return cpuOutputData;
    };
    /**
     * Validates static parameters for the CPU plugin using Zod schema.
     */
    const validateInput = (input) => {
        const schema = zod_1.z.object({
            duration: zod_1.z.number().gt(0),
            'cpu/name': zod_1.z.string(),
            'cpu/number-cores': zod_1.z.number(),
            'cpu/expected-lifespan': zod_1.z.number().optional(),
        });
        return (0, validations_1.validate)(schema, input);
    };
    return {
        metadata,
        execute,
    };
};
exports.BoaviztaCpuOutput = BoaviztaCpuOutput;
const BoaviztaCloudOutput = (globalConfig) => {
    const metadata = { kind: 'execute' };
    const instanceTypes = {};
    const errorBuilder = (0, helpers_1.buildErrorMessage)(exports.BoaviztaCloudOutput.name);
    /**
     * Calculates the output of the given usage.
     */
    const execute = async (inputs) => {
        const result = [];
        for await (const input of inputs) {
            const safeInput = Object.assign({}, input, validateInput(input));
            const metricTypeData = baseOutput.getMetricTypeData(input);
            const metricType = Object.keys(metricTypeData)[0];
            const mergedWithConfig = Object.assign({}, input, safeInput, { [metricType]: metricTypeData[metricType] }, globalConfig);
            await validateProvider(safeInput);
            await validateInstanceType(safeInput);
            await validateLocation(safeInput);
            const usageResult = await baseOutput.calculateUsagePerInput(mergedWithConfig, fetchData);
            result.push({
                ...input,
                ...usageResult,
            });
        }
        return result;
    };
    /**
     * Fetches data from the Boavizta API for the Cloud plugin.
     */
    const fetchData = async (input, usage) => {
        const data = Object.assign({}, input, { usage });
        const verbose = (globalConfig && globalConfig.verbose) || false;
        const response = await boaviztaAPI.fetchCloudInstanceData(data, verbose);
        return baseOutput.formatResponse(response);
    };
    /**
     * Validates static parameters for the Cloud plugin using Zod schema.
     */
    const validateInput = (input) => {
        const schema = zod_1.z.object({
            duration: zod_1.z.number().gt(0),
            provider: zod_1.z.string(),
            'instance-type': zod_1.z.string(),
            verbose: zod_1.z.boolean().optional(),
            'cpu/expected-lifespan': zod_1.z.number().optional(),
        });
        return (0, validations_1.validate)(schema, input);
    };
    /**
     * Validates the provider parameter for the Cloud plugin.
     */
    const validateProvider = async (staticParams) => {
        const supportedProviders = await boaviztaAPI.getSupportedProvidersList();
        if (!supportedProviders.includes(staticParams.provider)) {
            const whiteListedProviders = supportedProviders.join(', ');
            throw new InputValidationError(errorBuilder({
                message: `Invalid 'provider' parameter '${staticParams.provider}'. Valid values are ${whiteListedProviders}`,
            }));
        }
    };
    /**
     * Validates the instance type parameter for the Cloud plugin.
     */
    const validateInstanceType = async (staticParams) => {
        const provider = staticParams.provider;
        if (!instanceTypes[provider] || instanceTypes[provider].length === 0) {
            instanceTypes[provider] =
                await boaviztaAPI.getSupportedInstancesList(provider);
        }
        if (!instanceTypes[provider].includes(staticParams['instance-type'])) {
            const whiteListedTypes = instanceTypes[provider].join(', ');
            throw new UnsupportedValueError(errorBuilder({
                message: `Invalid 'instance-type' parameter: '${staticParams['instance-type']}'. Valid values are : ${whiteListedTypes}`,
            }));
        }
    };
    /**
     * Validates the country parameter for the Cloud plugin.
     */
    const validateLocation = async (staticParams) => {
        if ('country' in staticParams) {
            const countries = await boaviztaAPI.getSupportedLocations();
            const whitelistedCountries = countries.join(', ');
            if (!countries.includes(staticParams.country)) {
                throw new InputValidationError(errorBuilder({
                    message: `Invalid country parameter country. Valid values are ${whitelistedCountries}`,
                }));
            }
            return staticParams.country;
        }
    };
    return {
        metadata,
        execute,
    };
};
exports.BoaviztaCloudOutput = BoaviztaCloudOutput;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2JvYXZpenRhL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUFzQjtBQUt0Qix3REFBZ0Q7QUFDaEQsZ0RBQXFEO0FBQ3JELDhDQUF5QztBQUV6QywrQ0FBaUQ7QUFDakQsaURBQTJDO0FBUTNDLE1BQU0sRUFBQyxvQkFBb0IsRUFBRSxxQkFBcUIsRUFBQyxHQUFHLGVBQU0sQ0FBQztBQUM3RCxNQUFNLFdBQVcsR0FBRyxJQUFBLDBCQUFXLEdBQUUsQ0FBQztBQUNsQyxNQUFNLFVBQVUsR0FBRyxJQUFBLGdDQUFrQixHQUFFLENBQUM7QUFFakMsTUFBTSxpQkFBaUIsR0FBRyxDQUMvQixZQUEwQixFQUNULEVBQUU7SUFDbkIsTUFBTSxRQUFRLEdBQUcsRUFBQyxJQUFJLEVBQUUsU0FBUyxFQUFDLENBQUM7SUFDbkMsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDO0lBRTVCOztPQUVHO0lBQ0gsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLE1BQXNCLEVBQUUsRUFBRTtRQUMvQyxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFFbEIsSUFBSSxLQUFLLEVBQUUsTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQ2hDLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDM0QsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVsRCxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQ3BDLEVBQUUsRUFDRixLQUFLLEVBQ0wsU0FBUyxFQUNULEVBQUMsQ0FBQyxVQUFVLENBQUMsRUFBRSxjQUFjLENBQUMsVUFBVSxDQUFDLEVBQUMs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QUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQUU7WUFDcEUsTUFBTSxnQkFBZ0IsR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTVELE1BQU0sSUFBSSxxQkFBcUIsQ0FDN0IsWUFBWSxDQUFDO2dCQUNYLE9BQU8sRUFBRSx1Q0FBdUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyx5QkFBeUIsZ0JBQWdCLEVBQUU7YUFDekgsQ0FBQyxDQUNILENBQUM7U0FDSDtJQUNILENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLEVBQzVCLFlBQTBCLEVBQ0YsRUFBRTtRQUMxQixJQUFJLFNBQVMsSUFBSSxZQUFZLEVBQUU7WUFDN0IsTUFBTSxTQUFTLEdBQUcsTUFBTSxXQUFXLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUM1RCxNQUFNLG9CQUFvQixHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFbEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUM3QyxNQUFNLElBQUksb0JBQW9CLENBQzVCLFlBQVksQ0FBQztvQkFDWCxPQUFPLEVBQUUsdURBQXVELG9CQUFvQixFQUFFO2lCQUN2RixDQUFDLENBQ0gsQ0FBQzthQUNIO1lBRUQsT0FBTyxZQUFZLENBQUMsT0FBTyxDQUFDO1NBQzdCO0lBQ0gsQ0FBQyxDQUFDO0lBRUYsT0FBTztRQUNMLFFBQVE7UUFDUixPQUFPO0tBQ1IsQ0FBQztBQUNKLENBQUMsQ0FBQztBQXpJVyxRQUFBLG1CQUFtQix1QkF5STlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHt6fSBmcm9tICd6b2QnO1xuXG5pbXBvcnQge1BsdWdpbkludGVyZmFjZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge0NvbmZpZ1BhcmFtcywgUGx1Z2luUGFyYW1zfSBmcm9tICcuLi8uLi90eXBlcyc7XG5cbmltcG9ydCB7dmFsaWRhdGV9IGZyb20gJy4uLy4uL3V0aWwvdmFsaWRhdGlvbnMnO1xuaW1wb3J0IHtidWlsZEVycm9yTWVzc2FnZX0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJztcbmltcG9ydCB7RVJST1JTfSBmcm9tICcuLi8uLi91dGlsL2Vycm9ycyc7XG5cbmltcG9ydCB7Qm9hdml6dGFCYXNlT3V0cHV0fSBmcm9tICcuL2Jhc2Utb3V0cHV0JztcbmltcG9ydCB7Qm9hdml6dGFBUEl9IGZyb20gJy4vYm9hdml6dGEtYXBpJztcbmltcG9ydCB7XG4gIEJvYXZpenRhSW5zdGFuY2VUeXBlcyxcbiAgQm9hdml6dGFVc2FnZVR5cGUsXG4gIEJvYXZpenRhQ3B1T3V0cHV0VHlwZSxcbiAgQm9hdml6dGFDbG91ZEluc3RhbmNlVHlwZSxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmNvbnN0IHtJbnB1dFZhbGlkYXRpb25FcnJvciwgVW5zdXBwb3J0ZWRWYWx1ZUVycm9yfSA9IEVSUk9SUztcbmNvbnN0IGJvYXZpenRhQVBJID0gQm9hdml6dGFBUEkoKTtcbmNvbnN0IGJhc2VPdXRwdXQgPSBCb2F2aXp0YUJhc2VPdXRwdXQoKTtcblxuZXhwb3J0IGNvbnN0IEJvYXZpenRhQ3B1T3V0cHV0ID0gKFxuICBnbG9iYWxDb25maWc6IENvbmZpZ1BhcmFtc1xuKTogUGx1Z2luSW50ZXJmYWNlID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSB7a2luZDogJ2V4ZWN1dGUnfTtcbiAgY29uc3QgY29tcG9uZW50VHlwZSA9ICdjcHUnO1xuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGVzIHRoZSBvdXRwdXQgb2YgdGhlIGdpdmVuIHVzYWdlLlxuICAgKi9cbiAgY29uc3QgZXhlY3V0ZSA9IGFzeW5jIChpbnB1dHM6IFBsdWdpblBhcmFtc1tdKSA9PiB7XG4gICAgY29uc3QgcmVzdWx0ID0gW107XG5cbiAgICBmb3IgYXdhaXQgKGNvbnN0IGlucHV0IG9mIGlucHV0cykge1xuICAgICAgY29uc3Qgc2FmZUlucHV0ID0gdmFsaWRhdGVJbnB1dChpbnB1dCk7XG4gICAgICBjb25zdCBtZXRyaWNUeXBlRGF0YSA9IGJhc2VPdXRwdXQuZ2V0TWV0cmljVHlwZURhdGEoaW5wdXQpO1xuICAgICAgY29uc3QgbWV0cmljVHlwZSA9IE9iamVjdC5rZXlzKG1ldHJpY1R5cGVEYXRhKVswXTtcblxuICAgICAgY29uc3QgbWVyZ2VkV2l0aENvbmZpZyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICAgIHt9LFxuICAgICAgICBpbnB1dCxcbiAgICAgICAgc2FmZUlucHV0LFxuICAgICAgICB7W21ldHJpY1R5cGVdOiBtZXRyaWNUeXBlRGF0YVttZXRyaWNUeXBlXX0sXG4gICAgICAgIGdsb2JhbENvbmZpZ1xuICAgICAgKTtcblxuICAgICAgY29uc3QgdXNhZ2VSZXN1bHQgPSBhd2FpdCBiYXNlT3V0cHV0LmNhbGN1bGF0ZVVzYWdlUGVySW5wdXQoXG4gICAgICAgIG1lcmdlZFdpdGhDb25maWcsXG4gICAgICAgIGZldGNoRGF0YVxuICAgICAgKTtcblxuICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICAuLi5pbnB1dCxcbiAgICAgICAgLi4udXNhZ2VSZXN1bHQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBGZXRjaGVzIGRhdGEgZnJvbSB0aGUgQm9hdml6dGEgQVBJIGZvciB0aGUgQ1BVIHBsdWdpbi5cbiAgICovXG4gIGNvbnN0IGZldGNoRGF0YSA9IGFzeW5jIChcbiAgICBpbnB1dDogUGx1Z2luUGFyYW1zLFxuICAgIHVzYWdlOiBCb2F2aXp0YVVzYWdlVHlwZSB8IHVuZGVmaW5lZFxuICApOiBQcm9taXNlPEJvYXZpenRhQ3B1T3V0cHV0VHlwZT4gPT4ge1xuICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBpbnB1dCwge3VzYWdlfSk7XG4gICAgY29uc3QgdmVyYm9zZSA9IChnbG9iYWxDb25maWcgJiYgZ2xvYmFsQ29uZmlnLnZlcmJvc2UpIHx8IGZhbHNlO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYm9hdml6dGFBUEkuZmV0Y2hDcHVPdXRwdXREYXRhKFxuICAgICAgZGF0YSxcbiAgICAgIGNvbXBvbmVudFR5cGUsXG4gICAgICB2ZXJib3NlXG4gICAgKTtcbiAgICBjb25zdCByZXN1bHQgPSBiYXNlT3V0cHV0LmZvcm1hdFJlc3BvbnNlKHJlc3BvbnNlKTtcbiAgICBjb25zdCBjcHVPdXRwdXREYXRhOiBCb2F2aXp0YUNwdU91dHB1dFR5cGUgPSB7XG4gICAgICAnY3B1L2VuZXJneSc6IHJlc3VsdC5lbmVyZ3ksXG4gICAgICAnY2FyYm9uLWVtYm9kaWVkJzogcmVzdWx0WydjYXJib24tZW1ib2RpZWQnXSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGNwdU91dHB1dERhdGE7XG4gIH07XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyBzdGF0aWMgcGFyYW1ldGVycyBmb3IgdGhlIENQVSBwbHVnaW4gdXNpbmcgWm9kIHNjaGVtYS5cbiAgICovXG4gIGNvbnN0IHZhbGlkYXRlSW5wdXQgPSAoaW5wdXQ6IFBsdWdpblBhcmFtcykgPT4ge1xuICAgIGNvbnN0IHNjaGVtYSA9IHoub2JqZWN0KHtcbiAgICAgIGR1cmF0aW9uOiB6Lm51bWJlcigpLmd0KDApLFxuICAgICAgJ2NwdS9uYW1lJzogei5zdHJpbmcoKSxcbiAgICAgICdjcHUvbnVtYmVyLWNvcmVzJzogei5udW1iZXIoKSxcbiAgICAgICdjcHUvZXhwZWN0ZWQtbGlmZXNwYW4nOiB6Lm51bWJlcigpLm9wdGlvbmFsKCksXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdmFsaWRhdGU8ei5pbmZlcjx0eXBlb2Ygc2NoZW1hPj4oc2NoZW1hLCBpbnB1dCk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBtZXRhZGF0YSxcbiAgICBleGVjdXRlLFxuICB9O1xufTtcblxuZXhwb3J0IGNvbnN0IEJvYXZpenRhQ2xvdWRPdXRwdXQgPSAoXG4gIGdsb2JhbENvbmZpZzogQ29uZmlnUGFyYW1zXG4pOiBQbHVnaW5JbnRlcmZhY2UgPT4ge1xuICBjb25zdCBtZXRhZGF0YSA9IHtraW5kOiAnZXhlY3V0ZSd9O1xuICBjb25zdCBpbnN0YW5jZVR5cGVzOiBCb2F2aXp0YUluc3RhbmNlVHlwZXMgPSB7fTtcbiAgY29uc3QgZXJyb3JCdWlsZGVyID0gYnVpbGRFcnJvck1lc3NhZ2UoQm9hdml6dGFDbG91ZE91dHB1dC5uYW1lKTtcblxuICAvKipcbiAgICogQ2FsY3VsYXRlcyB0aGUgb3V0cHV0IG9mIHRoZSBnaXZlbiB1c2FnZS5cbiAgICovXG4gIGNvbnN0IGV4ZWN1dGUgPSBhc3luYyAoaW5wdXRzOiBQbHVnaW5QYXJhbXNbXSkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuXG4gICAgZm9yIGF3YWl0IChjb25zdCBpbnB1dCBvZiBpbnB1dHMpIHtcbiAgICAgIGNvbnN0IHNhZmVJbnB1dCA9IE9iamVjdC5hc3NpZ24oe30sIGlucHV0LCB2YWxpZGF0ZUlucHV0KGlucHV0KSk7XG4gICAgICBjb25zdCBtZXRyaWNUeXBlRGF0YSA9IGJhc2VPdXRwdXQuZ2V0TWV0cmljVHlwZURhdGEoaW5wdXQpO1xuICAgICAgY29uc3QgbWV0cmljVHlwZSA9IE9iamVjdC5rZXlzKG1ldHJpY1R5cGVEYXRhKVswXTtcbiAgICAgIGNvbnN0IG1lcmdlZFdpdGhDb25maWcgPSBPYmplY3QuYXNzaWduKFxuICAgICAgICB7fSxcbiAgICAgICAgaW5wdXQsXG4gICAgICAgIHNhZmVJbnB1dCxcbiAgICAgICAge1ttZXRyaWNUeXBlXTogbWV0cmljVHlwZURhdGFbbWV0cmljVHlwZV19LFxuICAgICAgICBnbG9iYWxDb25maWdcbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IHZhbGlkYXRlUHJvdmlkZXIoc2FmZUlucHV0KTtcbiAgICAgIGF3YWl0IHZhbGlkYXRlSW5zdGFuY2VUeXBlKHNhZmVJbnB1dCk7XG4gICAgICBhd2FpdCB2YWxpZGF0ZUxvY2F0aW9uKHNhZmVJbnB1dCk7XG5cbiAgICAgIGNvbnN0IHVzYWdlUmVzdWx0ID0gYXdhaXQgYmFzZU91dHB1dC5jYWxjdWxhdGVVc2FnZVBlcklucHV0KFxuICAgICAgICBtZXJnZWRXaXRoQ29uZmlnLFxuICAgICAgICBmZXRjaERhdGFcbiAgICAgICk7XG5cbiAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgLi4uaW5wdXQsXG4gICAgICAgIC4uLnVzYWdlUmVzdWx0LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICAvKipcbiAgICogRmV0Y2hlcyBkYXRhIGZyb20gdGhlIEJvYXZpenRhIEFQSSBmb3IgdGhlIENsb3VkIHBsdWdpbi5cbiAgICovXG4gIGNvbnN0IGZldGNoRGF0YSA9IGFzeW5jIChcbiAgICBpbnB1dDogUGx1Z2luUGFyYW1zLFxuICAgIHVzYWdlOiBCb2F2aXp0YVVzYWdlVHlwZVxuICApOiBQcm9taXNlPEJvYXZpenRhQ2xvdWRJbnN0YW5jZVR5cGU+ID0+IHtcbiAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgaW5wdXQsIHt1c2FnZX0pO1xuICAgIGNvbnN0IHZlcmJvc2UgPSAoZ2xvYmFsQ29uZmlnICYmIGdsb2JhbENvbmZpZy52ZXJib3NlKSB8fCBmYWxzZTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGJvYXZpenRhQVBJLmZldGNoQ2xvdWRJbnN0YW5jZURhdGEoZGF0YSwgdmVyYm9zZSk7XG5cbiAgICByZXR1cm4gYmFzZU91dHB1dC5mb3JtYXRSZXNwb25zZShyZXNwb25zZSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyBzdGF0aWMgcGFyYW1ldGVycyBmb3IgdGhlIENsb3VkIHBsdWdpbiB1c2luZyBab2Qgc2NoZW1hLlxuICAgKi9cbiAgY29uc3QgdmFsaWRhdGVJbnB1dCA9IChpbnB1dDogUGx1Z2luUGFyYW1zKSA9PiB7XG4gICAgY29uc3Qgc2NoZW1hID0gei5vYmplY3Qoe1xuICAgICAgZHVyYXRpb246IHoubnVtYmVyKCkuZ3QoMCksXG4gICAgICBwcm92aWRlcjogei5zdHJpbmcoKSxcbiAgICAgICdpbnN0YW5jZS10eXBlJzogei5zdHJpbmcoKSxcbiAgICAgIHZlcmJvc2U6IHouYm9vbGVhbigpLm9wdGlvbmFsKCksXG4gICAgICAnY3B1L2V4cGVjdGVkLWxpZmVzcGFuJzogei5udW1iZXIoKS5vcHRpb25hbCgpLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHZhbGlkYXRlPHouaW5mZXI8dHlwZW9mIHNjaGVtYT4+KHNjaGVtYSwgaW5wdXQpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgdGhlIHByb3ZpZGVyIHBhcmFtZXRlciBmb3IgdGhlIENsb3VkIHBsdWdpbi5cbiAgICovXG4gIGNvbnN0IHZhbGlkYXRlUHJvdmlkZXIgPSBhc3luYyAoc3RhdGljUGFyYW1zOiBQbHVnaW5QYXJhbXMpID0+IHtcbiAgICBjb25zdCBzdXBwb3J0ZWRQcm92aWRlcnMgPSBhd2FpdCBib2F2aXp0YUFQSS5nZXRTdXBwb3J0ZWRQcm92aWRlcnNMaXN0KCk7XG5cbiAgICBpZiAoIXN1cHBvcnRlZFByb3ZpZGVycy5pbmNsdWRlcyhzdGF0aWNQYXJhbXMucHJvdmlkZXIpKSB7XG4gICAgICBjb25zdCB3aGl0ZUxpc3RlZFByb3ZpZGVycyA9IHN1cHBvcnRlZFByb3ZpZGVycy5qb2luKCcsICcpO1xuXG4gICAgICB0aHJvdyBuZXcgSW5wdXRWYWxpZGF0aW9uRXJyb3IoXG4gICAgICAgIGVycm9yQnVpbGRlcih7XG4gICAgICAgICAgbWVzc2FnZTogYEludmFsaWQgJ3Byb3ZpZGVyJyBwYXJhbWV0ZXIgJyR7c3RhdGljUGFyYW1zLnByb3ZpZGVyfScuIFZhbGlkIHZhbHVlcyBhcmUgJHt3aGl0ZUxpc3RlZFByb3ZpZGVyc31gLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyB0aGUgaW5zdGFuY2UgdHlwZSBwYXJhbWV0ZXIgZm9yIHRoZSBDbG91ZCBwbHVnaW4uXG4gICAqL1xuICBjb25zdCB2YWxpZGF0ZUluc3RhbmNlVHlwZSA9IGFzeW5jIChzdGF0aWNQYXJhbXM6IFBsdWdpblBhcmFtcykgPT4ge1xuICAgIGNvbnN0IHByb3ZpZGVyID0gc3RhdGljUGFyYW1zLnByb3ZpZGVyO1xuXG4gICAgaWYgKCFpbnN0YW5jZVR5cGVzW3Byb3ZpZGVyXSB8fCBpbnN0YW5jZVR5cGVzW3Byb3ZpZGVyXS5sZW5ndGggPT09IDApIHtcbiAgICAgIGluc3RhbmNlVHlwZXNbcHJvdmlkZXJdID1cbiAgICAgICAgYXdhaXQgYm9hdml6dGFBUEkuZ2V0U3VwcG9ydGVkSW5zdGFuY2VzTGlzdChwcm92aWRlcik7XG4gICAgfVxuXG4gICAgaWYgKCFpbnN0YW5jZVR5cGVzW3Byb3ZpZGVyXS5pbmNsdWRlcyhzdGF0aWNQYXJhbXNbJ2luc3RhbmNlLXR5cGUnXSkpIHtcbiAgICAgIGNvbnN0IHdoaXRlTGlzdGVkVHlwZXMgPSBpbnN0YW5jZVR5cGVzW3Byb3ZpZGVyXS5qb2luKCcsICcpO1xuXG4gICAgICB0aHJvdyBuZXcgVW5zdXBwb3J0ZWRWYWx1ZUVycm9yKFxuICAgICAgICBlcnJvckJ1aWxkZXIoe1xuICAgICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkICdpbnN0YW5jZS10eXBlJyBwYXJhbWV0ZXI6ICcke3N0YXRpY1BhcmFtc1snaW5zdGFuY2UtdHlwZSddfScuIFZhbGlkIHZhbHVlcyBhcmUgOiAke3doaXRlTGlzdGVkVHlwZXN9YCxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgdGhlIGNvdW50cnkgcGFyYW1ldGVyIGZvciB0aGUgQ2xvdWQgcGx1Z2luLlxuICAgKi9cbiAgY29uc3QgdmFsaWRhdGVMb2NhdGlvbiA9IGFzeW5jIChcbiAgICBzdGF0aWNQYXJhbXM6IFBsdWdpblBhcmFtc1xuICApOiBQcm9taXNlPHN0cmluZyB8IHZvaWQ+ID0+IHtcbiAgICBpZiAoJ2NvdW50cnknIGluIHN0YXRpY1BhcmFtcykge1xuICAgICAgY29uc3QgY291bnRyaWVzID0gYXdhaXQgYm9hdml6dGFBUEkuZ2V0U3VwcG9ydGVkTG9jYXRpb25zKCk7XG4gICAgICBjb25zdCB3aGl0ZWxpc3RlZENvdW50cmllcyA9IGNvdW50cmllcy5qb2luKCcsICcpO1xuXG4gICAgICBpZiAoIWNvdW50cmllcy5pbmNsdWRlcyhzdGF0aWNQYXJhbXMuY291bnRyeSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IElucHV0VmFsaWRhdGlvbkVycm9yKFxuICAgICAgICAgIGVycm9yQnVpbGRlcih7XG4gICAgICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBjb3VudHJ5IHBhcmFtZXRlciBjb3VudHJ5LiBWYWxpZCB2YWx1ZXMgYXJlICR7d2hpdGVsaXN0ZWRDb3VudHJpZXN9YCxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gc3RhdGljUGFyYW1zLmNvdW50cnk7XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiB7XG4gICAgbWV0YWRhdGEsXG4gICAgZXhlY3V0ZSxcbiAgfTtcbn07XG4iXX0=