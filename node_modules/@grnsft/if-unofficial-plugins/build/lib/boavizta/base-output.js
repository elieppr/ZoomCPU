"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BoaviztaBaseOutput = void 0;
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const { InputValidationError } = errors_1.ERRORS;
const BoaviztaBaseOutput = () => {
    const METRIC_TYPES = ['cpu/utilization', 'gpu-util', 'ram-util'];
    const expectedLifespan = 4 * 365 * 24 * 60 * 60;
    const errorBuilder = (0, helpers_1.buildErrorMessage)(exports.BoaviztaBaseOutput.name);
    /**
     * Converts the usage from manifest input to the format required by Boavizta API.
     */
    const transformToBoaviztaUsage = (input) => {
        const metricType = validateMetricType(input);
        // duration is in seconds, convert to hours
        // metric is between 0 and 1, convert to percentage
        const usageInput = {
            hours_use_time: input['duration'] / 3600.0,
            time_workload: [input[metricType]],
        };
        // convert expected lifespan from seconds to years
        const expectedLifeTime = (input['cpu/expected-lifespan'] || expectedLifespan) /
            (365.0 * 24.0 * 60.0 * 60.0);
        usageInput['years_life_time'] = expectedLifeTime;
        return addLocationToUsage(input, usageInput);
    };
    /**
     * Adds country to usage if country is defined in sharedParams.
     */
    const addLocationToUsage = (input, usageRaw) => {
        if ('country' in input) {
            usageRaw['usage_location'] = input['country'];
        }
        return usageRaw;
    };
    /**
     * Formats the response by converting units and extracting relevant data.
     * Coverts the embodied carbon value from kgCO2eq to gCO2eq, defaulting to 0 if 'impacts' is not present.
     * Converts the energy value from J to kWh, defaulting to 0 if 'impacts' is not present.
     * 1,000,000 J / 3600 = 277.7777777777778 Wh.
     * 1 MJ / 3.6 = 0.278 kWh
     */
    const formatResponse = (data) => {
        const impactsInData = 'impacts' in data;
        const embodiedCarbon = impactsInData
            ? data.impacts.gwp.embedded.value * 1000
            : 0;
        const energy = impactsInData ? data.impacts.pe.use.value / 3.6 : 0;
        return { 'carbon-embodied': embodiedCarbon, energy };
    };
    /**
     * Get the provided metric type in input.
     */
    const getMetricType = (input) => METRIC_TYPES.find(key => key in input);
    /**
     * Validates metric type.
     */
    const validateMetricType = (input) => {
        const metricType = getMetricType(input);
        if (!metricType) {
            throw new InputValidationError(errorBuilder({
                message: `One of these ${METRIC_TYPES} parameters should be provided in the input`,
            }));
        }
        return metricType;
    };
    /**
     * Gets metric type data if provided in the input.
     */
    const getMetricTypeData = (input) => {
        const metricType = validateMetricType(input);
        const metricTypeValue = metricType === 'cpu/utilization'
            ? {
                load_percentage: input['cpu/utilization'],
                time_percentage: 100,
            }
            : input[metricType];
        return {
            [metricType]: metricTypeValue,
        };
    };
    /**
     * Converts the usage to the format required by Boavizta API.
     */
    const calculateUsagePerInput = async (input, fetchData) => {
        const { hours_use_time, time_workload, years_life_time, usage_location } = transformToBoaviztaUsage(input);
        return fetchData(input, {
            hours_use_time,
            time_workload,
            years_life_time,
            usage_location,
        });
    };
    return {
        formatResponse,
        calculateUsagePerInput,
        getMetricTypeData,
    };
};
exports.BoaviztaBaseOutput = BoaviztaBaseOutput;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1vdXRwdXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2JvYXZpenRhL2Jhc2Utb3V0cHV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGdEQUFxRDtBQUNyRCw4Q0FBeUM7QUFFekMsTUFBTSxFQUFDLG9CQUFvQixFQUFDLEdBQUcsZUFBTSxDQUFDO0FBRS9CLE1BQU0sa0JBQWtCLEdBQUcsR0FBRyxFQUFFO0lBQ3JDLE1BQU0sWUFBWSxHQUFHLENBQUMsaUJBQWlCLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBVSxDQUFDO0lBQzFFLE1BQU0sZ0JBQWdCLEdBQVcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUN4RCxNQUFNLFlBQVksR0FBRyxJQUFBLDJCQUFpQixFQUFDLDBCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRWhFOztPQUVHO0lBQ0gsTUFBTSx3QkFBd0IsR0FBRyxDQUFDLEtBQW1CLEVBQUUsRUFBRTtRQUN2RCxNQUFNLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3QywyQ0FBMkM7UUFDM0MsbURBQW1EO1FBQ25ELE1BQU0sVUFBVSxHQUFpQjtZQUMvQixjQUFjLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU07WUFDMUMsYUFBYSxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ25DLENBQUM7UUFFRixrREFBa0Q7UUFDbEQsTUFBTSxnQkFBZ0IsR0FDcEIsQ0FBQyxLQUFLLENBQUMsdUJBQXVCLENBQUMsSUFBSSxnQkFBZ0IsQ0FBQztZQUNwRCxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRS9CLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLGdCQUFnQixDQUFDO1FBRWpELE9BQU8sa0JBQWtCLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEtBQW1CLEVBQUUsUUFBc0IsRUFBRSxFQUFFO1FBQ3pFLElBQUksU0FBUyxJQUFJLEtBQUssRUFBRTtZQUN0QixRQUFRLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDL0M7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDLENBQUM7SUFFRjs7Ozs7O09BTUc7SUFDSCxNQUFNLGNBQWMsR0FBRyxDQUFDLElBQWtCLEVBQUUsRUFBRTtRQUM1QyxNQUFNLGFBQWEsR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDO1FBQ3hDLE1BQU0sY0FBYyxHQUFHLGFBQWE7WUFDbEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSTtZQUN4QyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ04sTUFBTSxNQUFNLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRW5FLE9BQU8sRUFBQyxpQkFBaUIsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFDLENBQUM7SUFDckQsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxNQUFNLGFBQWEsR0FBRyxDQUFDLEtBQW1CLEVBQUUsRUFBRSxDQUM1QyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDO0lBRXpDOztPQUVHO0lBQ0gsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEtBQW1CLEVBQUUsRUFBRTtRQUNqRCxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLE1BQU0sSUFBSSxvQkFBb0IsQ0FDNUIsWUFBWSxDQUFDO2dCQUNYLE9BQU8sRUFBRSxnQkFBZ0IsWUFBWSw2Q0FBNkM7YUFDbkYsQ0FBQyxDQUNILENBQUM7U0FDSDtRQUVELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUMsQ0FBQztJQUNGOztPQUVHO0lBQ0gsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEtBQW1CLEVBQUUsRUFBRTtRQUNoRCxNQUFNLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3QyxNQUFNLGVBQWUsR0FDbkIsVUFBVSxLQUFLLGlCQUFpQjtZQUM5QixDQUFDLENBQUM7Z0JBQ0UsZUFBZSxFQUFFLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQztnQkFDekMsZUFBZSxFQUFFLEdBQUc7YUFDckI7WUFDSCxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXhCLE9BQU87WUFDTCxDQUFDLFVBQVUsQ0FBQyxFQUFFLGVBQWU7U0FDOUIsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsTUFBTSxzQkFBc0IsR0FBRyxLQUFLLEVBQ2xDLEtBQW1CLEVBQ25CLFNBQW1CLEVBQ25CLEVBQUU7UUFDRixNQUFNLEVBQUMsY0FBYyxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFDLEdBQ3BFLHdCQUF3QixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWxDLE9BQU8sU0FBUyxDQUFDLEtBQUssRUFBRTtZQUN0QixjQUFjO1lBQ2QsYUFBYTtZQUNiLGVBQWU7WUFDZixjQUFjO1NBQ2YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0lBRUYsT0FBTztRQUNMLGNBQWM7UUFDZCxzQkFBc0I7UUFDdEIsaUJBQWlCO0tBQ2xCLENBQUM7QUFDSixDQUFDLENBQUM7QUF2SFcsUUFBQSxrQkFBa0Isc0JBdUg3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7S2V5VmFsdWVQYWlyLCBQbHVnaW5QYXJhbXN9IGZyb20gJy4uLy4uL3R5cGVzL2NvbW1vbic7XG5pbXBvcnQge2J1aWxkRXJyb3JNZXNzYWdlfSBmcm9tICcuLi8uLi91dGlsL2hlbHBlcnMnO1xuaW1wb3J0IHtFUlJPUlN9IGZyb20gJy4uLy4uL3V0aWwvZXJyb3JzJztcblxuY29uc3Qge0lucHV0VmFsaWRhdGlvbkVycm9yfSA9IEVSUk9SUztcblxuZXhwb3J0IGNvbnN0IEJvYXZpenRhQmFzZU91dHB1dCA9ICgpID0+IHtcbiAgY29uc3QgTUVUUklDX1RZUEVTID0gWydjcHUvdXRpbGl6YXRpb24nLCAnZ3B1LXV0aWwnLCAncmFtLXV0aWwnXSBhcyBjb25zdDtcbiAgY29uc3QgZXhwZWN0ZWRMaWZlc3BhbjogbnVtYmVyID0gNCAqIDM2NSAqIDI0ICogNjAgKiA2MDtcbiAgY29uc3QgZXJyb3JCdWlsZGVyID0gYnVpbGRFcnJvck1lc3NhZ2UoQm9hdml6dGFCYXNlT3V0cHV0Lm5hbWUpO1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aGUgdXNhZ2UgZnJvbSBtYW5pZmVzdCBpbnB1dCB0byB0aGUgZm9ybWF0IHJlcXVpcmVkIGJ5IEJvYXZpenRhIEFQSS5cbiAgICovXG4gIGNvbnN0IHRyYW5zZm9ybVRvQm9hdml6dGFVc2FnZSA9IChpbnB1dDogUGx1Z2luUGFyYW1zKSA9PiB7XG4gICAgY29uc3QgbWV0cmljVHlwZSA9IHZhbGlkYXRlTWV0cmljVHlwZShpbnB1dCk7XG5cbiAgICAvLyBkdXJhdGlvbiBpcyBpbiBzZWNvbmRzLCBjb252ZXJ0IHRvIGhvdXJzXG4gICAgLy8gbWV0cmljIGlzIGJldHdlZW4gMCBhbmQgMSwgY29udmVydCB0byBwZXJjZW50YWdlXG4gICAgY29uc3QgdXNhZ2VJbnB1dDogS2V5VmFsdWVQYWlyID0ge1xuICAgICAgaG91cnNfdXNlX3RpbWU6IGlucHV0WydkdXJhdGlvbiddIC8gMzYwMC4wLFxuICAgICAgdGltZV93b3JrbG9hZDogW2lucHV0W21ldHJpY1R5cGVdXSxcbiAgICB9O1xuXG4gICAgLy8gY29udmVydCBleHBlY3RlZCBsaWZlc3BhbiBmcm9tIHNlY29uZHMgdG8geWVhcnNcbiAgICBjb25zdCBleHBlY3RlZExpZmVUaW1lID1cbiAgICAgIChpbnB1dFsnY3B1L2V4cGVjdGVkLWxpZmVzcGFuJ10gfHwgZXhwZWN0ZWRMaWZlc3BhbikgL1xuICAgICAgKDM2NS4wICogMjQuMCAqIDYwLjAgKiA2MC4wKTtcblxuICAgIHVzYWdlSW5wdXRbJ3llYXJzX2xpZmVfdGltZSddID0gZXhwZWN0ZWRMaWZlVGltZTtcblxuICAgIHJldHVybiBhZGRMb2NhdGlvblRvVXNhZ2UoaW5wdXQsIHVzYWdlSW5wdXQpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGRzIGNvdW50cnkgdG8gdXNhZ2UgaWYgY291bnRyeSBpcyBkZWZpbmVkIGluIHNoYXJlZFBhcmFtcy5cbiAgICovXG4gIGNvbnN0IGFkZExvY2F0aW9uVG9Vc2FnZSA9IChpbnB1dDogUGx1Z2luUGFyYW1zLCB1c2FnZVJhdzogS2V5VmFsdWVQYWlyKSA9PiB7XG4gICAgaWYgKCdjb3VudHJ5JyBpbiBpbnB1dCkge1xuICAgICAgdXNhZ2VSYXdbJ3VzYWdlX2xvY2F0aW9uJ10gPSBpbnB1dFsnY291bnRyeSddO1xuICAgIH1cblxuICAgIHJldHVybiB1c2FnZVJhdztcbiAgfTtcblxuICAvKipcbiAgICogRm9ybWF0cyB0aGUgcmVzcG9uc2UgYnkgY29udmVydGluZyB1bml0cyBhbmQgZXh0cmFjdGluZyByZWxldmFudCBkYXRhLlxuICAgKiBDb3ZlcnRzIHRoZSBlbWJvZGllZCBjYXJib24gdmFsdWUgZnJvbSBrZ0NPMmVxIHRvIGdDTzJlcSwgZGVmYXVsdGluZyB0byAwIGlmICdpbXBhY3RzJyBpcyBub3QgcHJlc2VudC5cbiAgICogQ29udmVydHMgdGhlIGVuZXJneSB2YWx1ZSBmcm9tIEogdG8ga1doLCBkZWZhdWx0aW5nIHRvIDAgaWYgJ2ltcGFjdHMnIGlzIG5vdCBwcmVzZW50LlxuICAgKiAxLDAwMCwwMDAgSiAvIDM2MDAgPSAyNzcuNzc3Nzc3Nzc3Nzc3OCBXaC5cbiAgICogMSBNSiAvIDMuNiA9IDAuMjc4IGtXaFxuICAgKi9cbiAgY29uc3QgZm9ybWF0UmVzcG9uc2UgPSAoZGF0YTogS2V5VmFsdWVQYWlyKSA9PiB7XG4gICAgY29uc3QgaW1wYWN0c0luRGF0YSA9ICdpbXBhY3RzJyBpbiBkYXRhO1xuICAgIGNvbnN0IGVtYm9kaWVkQ2FyYm9uID0gaW1wYWN0c0luRGF0YVxuICAgICAgPyBkYXRhLmltcGFjdHMuZ3dwLmVtYmVkZGVkLnZhbHVlICogMTAwMFxuICAgICAgOiAwO1xuICAgIGNvbnN0IGVuZXJneSA9IGltcGFjdHNJbkRhdGEgPyBkYXRhLmltcGFjdHMucGUudXNlLnZhbHVlIC8gMy42IDogMDtcblxuICAgIHJldHVybiB7J2NhcmJvbi1lbWJvZGllZCc6IGVtYm9kaWVkQ2FyYm9uLCBlbmVyZ3l9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHByb3ZpZGVkIG1ldHJpYyB0eXBlIGluIGlucHV0LlxuICAgKi9cbiAgY29uc3QgZ2V0TWV0cmljVHlwZSA9IChpbnB1dDogUGx1Z2luUGFyYW1zKSA9PlxuICAgIE1FVFJJQ19UWVBFUy5maW5kKGtleSA9PiBrZXkgaW4gaW5wdXQpO1xuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgbWV0cmljIHR5cGUuXG4gICAqL1xuICBjb25zdCB2YWxpZGF0ZU1ldHJpY1R5cGUgPSAoaW5wdXQ6IFBsdWdpblBhcmFtcykgPT4ge1xuICAgIGNvbnN0IG1ldHJpY1R5cGUgPSBnZXRNZXRyaWNUeXBlKGlucHV0KTtcbiAgICBpZiAoIW1ldHJpY1R5cGUpIHtcbiAgICAgIHRocm93IG5ldyBJbnB1dFZhbGlkYXRpb25FcnJvcihcbiAgICAgICAgZXJyb3JCdWlsZGVyKHtcbiAgICAgICAgICBtZXNzYWdlOiBgT25lIG9mIHRoZXNlICR7TUVUUklDX1RZUEVTfSBwYXJhbWV0ZXJzIHNob3VsZCBiZSBwcm92aWRlZCBpbiB0aGUgaW5wdXRgLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWV0cmljVHlwZTtcbiAgfTtcbiAgLyoqXG4gICAqIEdldHMgbWV0cmljIHR5cGUgZGF0YSBpZiBwcm92aWRlZCBpbiB0aGUgaW5wdXQuXG4gICAqL1xuICBjb25zdCBnZXRNZXRyaWNUeXBlRGF0YSA9IChpbnB1dDogUGx1Z2luUGFyYW1zKSA9PiB7XG4gICAgY29uc3QgbWV0cmljVHlwZSA9IHZhbGlkYXRlTWV0cmljVHlwZShpbnB1dCk7XG5cbiAgICBjb25zdCBtZXRyaWNUeXBlVmFsdWUgPVxuICAgICAgbWV0cmljVHlwZSA9PT0gJ2NwdS91dGlsaXphdGlvbidcbiAgICAgICAgPyB7XG4gICAgICAgICAgICBsb2FkX3BlcmNlbnRhZ2U6IGlucHV0WydjcHUvdXRpbGl6YXRpb24nXSxcbiAgICAgICAgICAgIHRpbWVfcGVyY2VudGFnZTogMTAwLFxuICAgICAgICAgIH1cbiAgICAgICAgOiBpbnB1dFttZXRyaWNUeXBlXTtcblxuICAgIHJldHVybiB7XG4gICAgICBbbWV0cmljVHlwZV06IG1ldHJpY1R5cGVWYWx1ZSxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aGUgdXNhZ2UgdG8gdGhlIGZvcm1hdCByZXF1aXJlZCBieSBCb2F2aXp0YSBBUEkuXG4gICAqL1xuICBjb25zdCBjYWxjdWxhdGVVc2FnZVBlcklucHV0ID0gYXN5bmMgKFxuICAgIGlucHV0OiBQbHVnaW5QYXJhbXMsXG4gICAgZmV0Y2hEYXRhOiBGdW5jdGlvblxuICApID0+IHtcbiAgICBjb25zdCB7aG91cnNfdXNlX3RpbWUsIHRpbWVfd29ya2xvYWQsIHllYXJzX2xpZmVfdGltZSwgdXNhZ2VfbG9jYXRpb259ID1cbiAgICAgIHRyYW5zZm9ybVRvQm9hdml6dGFVc2FnZShpbnB1dCk7XG5cbiAgICByZXR1cm4gZmV0Y2hEYXRhKGlucHV0LCB7XG4gICAgICBob3Vyc191c2VfdGltZSxcbiAgICAgIHRpbWVfd29ya2xvYWQsXG4gICAgICB5ZWFyc19saWZlX3RpbWUsXG4gICAgICB1c2FnZV9sb2NhdGlvbixcbiAgICB9KTtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIGZvcm1hdFJlc3BvbnNlLFxuICAgIGNhbGN1bGF0ZVVzYWdlUGVySW5wdXQsXG4gICAgZ2V0TWV0cmljVHlwZURhdGEsXG4gIH07XG59O1xuIl19