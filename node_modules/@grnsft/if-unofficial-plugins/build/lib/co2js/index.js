"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Co2js = void 0;
const co2_1 = require("@tgwf/co2");
const zod_1 = require("zod");
const validations_1 = require("../../util/validations");
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const { InputValidationError } = errors_1.ERRORS;
const Co2js = (globalConfig) => {
    const metadata = { kind: 'execute' };
    const errorBuilder = (0, helpers_1.buildErrorMessage)(exports.Co2js.name);
    /**
     * Executes the plugin for a list of input parameters.
     */
    const execute = async (inputs, config) => {
        const mergedValidatedConfig = Object.assign({}, validateConfig(config), validateGlobalConfig());
        const model = new co2_1.co2({ model: mergedValidatedConfig.type });
        return inputs.map(input => {
            const mergedWithConfig = Object.assign({}, validateInput(input), mergedValidatedConfig);
            const result = calculateResultByParams(mergedWithConfig, model);
            return result
                ? {
                    ...input,
                    'carbon-operational': result,
                }
                : input;
        });
    };
    /**
     * Calculates a result based on the provided static parameters type.
     */
    const calculateResultByParams = (inputWithConfig, model) => {
        const greenhosting = inputWithConfig['green-web-host'] === true;
        const options = inputWithConfig['options'];
        const GBinBytes = inputWithConfig['network/data'] * 1000 * 1000 * 1000;
        const bytes = inputWithConfig['network/data/bytes'] || GBinBytes;
        const paramType = {
            swd: () => {
                return options
                    ? model.perVisitTrace(bytes, greenhosting, options).co2
                    : model.perVisit(bytes, greenhosting);
            },
            '1byte': () => {
                return model.perByte(bytes, greenhosting);
            },
        };
        return paramType[inputWithConfig.type]();
    };
    /**
     * Validates input parameters.
     */
    const validateInput = (input) => {
        const schema = zod_1.z
            .object({
            'network/data/bytes': zod_1.z.number(),
            'network/data': zod_1.z.number(),
        })
            .partial()
            .refine(data => !!data['network/data/bytes'] || !!data['network/data'], {
            message: 'Either `network/data/bytes` or `network/data` should be provided in the input.',
        });
        return (0, validations_1.validate)(schema, input);
    };
    /**
     * Validates Global config parameters.
     */
    const validateGlobalConfig = () => {
        const schema = zod_1.z.object({
            options: zod_1.z
                .object({
                dataReloadRatio: zod_1.z.number().min(0).max(1).optional(),
                firstVisitPercentage: zod_1.z.number().min(0).max(1).optional(),
                returnVisitPercentage: zod_1.z.number().min(0).max(1).optional(),
                gridIntensity: zod_1.z
                    .object({
                    device: zod_1.z
                        .number()
                        .or(zod_1.z.object({ country: zod_1.z.string() }))
                        .optional(),
                    dataCenter: zod_1.z
                        .number()
                        .or(zod_1.z.object({ country: zod_1.z.string() }))
                        .optional(),
                    networks: zod_1.z
                        .number()
                        .or(zod_1.z.object({ country: zod_1.z.string() }))
                        .optional(),
                })
                    .optional(),
            })
                .optional(),
        });
        return (0, validations_1.validate)(schema, globalConfig || {});
    };
    /**
     * Validates node config parameters.
     */
    const validateConfig = (config) => {
        if (!config) {
            throw new InputValidationError(errorBuilder({
                message: 'Config is not provided',
            }));
        }
        const schema = zod_1.z
            .object({
            type: zod_1.z.enum(['1byte', 'swd']),
            'green-web-host': zod_1.z.boolean(),
        })
            .refine(validations_1.allDefined, {
            message: '`type` and `green-web-host` are not provided in node config',
        });
        return (0, validations_1.validate)(schema, config);
    };
    return {
        metadata,
        execute,
    };
};
exports.Co2js = Co2js;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2NvMmpzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUE4QjtBQUM5Qiw2QkFBc0I7QUFLdEIsd0RBQTREO0FBQzVELGdEQUFxRDtBQUNyRCw4Q0FBeUM7QUFFekMsTUFBTSxFQUFDLG9CQUFvQixFQUFDLEdBQUcsZUFBTSxDQUFDO0FBRS9CLE1BQU0sS0FBSyxHQUFHLENBQUMsWUFBMkIsRUFBbUIsRUFBRTtJQUNwRSxNQUFNLFFBQVEsR0FBRyxFQUFDLElBQUksRUFBRSxTQUFTLEVBQUMsQ0FBQztJQUNuQyxNQUFNLFlBQVksR0FBRyxJQUFBLDJCQUFpQixFQUFDLGFBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVuRDs7T0FFRztJQUNILE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxNQUFzQixFQUFFLE1BQXFCLEVBQUUsRUFBRTtRQUN0RSxNQUFNLHFCQUFxQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQ3pDLEVBQUUsRUFDRixjQUFjLENBQUMsTUFBTSxDQUFDLEVBQ3RCLG9CQUFvQixFQUFFLENBQ3ZCLENBQUM7UUFDRixNQUFNLEtBQUssR0FBRyxJQUFJLFNBQUcsQ0FBQyxFQUFDLEtBQUssRUFBRSxxQkFBcUIsQ0FBQyxJQUFJLEVBQUMsQ0FBQyxDQUFDO1FBRTNELE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN4QixNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQ3BDLEVBQUUsRUFDRixhQUFhLENBQUMsS0FBSyxDQUFDLEVBQ3BCLHFCQUFxQixDQUN0QixDQUFDO1lBQ0YsTUFBTSxNQUFNLEdBQUcsdUJBQXVCLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFaEUsT0FBTyxNQUFNO2dCQUNYLENBQUMsQ0FBQztvQkFDRSxHQUFHLEtBQUs7b0JBQ1Isb0JBQW9C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Q0FBQyxDQUFDO0FBeklXLFFBQUEsS0FBSyxTQXlJaEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2NvMn0gZnJvbSAnQHRnd2YvY28yJztcbmltcG9ydCB7en0gZnJvbSAnem9kJztcblxuaW1wb3J0IHtQbHVnaW5JbnRlcmZhY2V9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHtDb25maWdQYXJhbXMsIFBsdWdpblBhcmFtc30gZnJvbSAnLi4vLi4vdHlwZXMnO1xuXG5pbXBvcnQge2FsbERlZmluZWQsIHZhbGlkYXRlfSBmcm9tICcuLi8uLi91dGlsL3ZhbGlkYXRpb25zJztcbmltcG9ydCB7YnVpbGRFcnJvck1lc3NhZ2V9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycyc7XG5pbXBvcnQge0VSUk9SU30gZnJvbSAnLi4vLi4vdXRpbC9lcnJvcnMnO1xuXG5jb25zdCB7SW5wdXRWYWxpZGF0aW9uRXJyb3J9ID0gRVJST1JTO1xuXG5leHBvcnQgY29uc3QgQ28yanMgPSAoZ2xvYmFsQ29uZmlnPzogQ29uZmlnUGFyYW1zKTogUGx1Z2luSW50ZXJmYWNlID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSB7a2luZDogJ2V4ZWN1dGUnfTtcbiAgY29uc3QgZXJyb3JCdWlsZGVyID0gYnVpbGRFcnJvck1lc3NhZ2UoQ28yanMubmFtZSk7XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGVzIHRoZSBwbHVnaW4gZm9yIGEgbGlzdCBvZiBpbnB1dCBwYXJhbWV0ZXJzLlxuICAgKi9cbiAgY29uc3QgZXhlY3V0ZSA9IGFzeW5jIChpbnB1dHM6IFBsdWdpblBhcmFtc1tdLCBjb25maWc/OiBDb25maWdQYXJhbXMpID0+IHtcbiAgICBjb25zdCBtZXJnZWRWYWxpZGF0ZWRDb25maWcgPSBPYmplY3QuYXNzaWduKFxuICAgICAge30sXG4gICAgICB2YWxpZGF0ZUNvbmZpZyhjb25maWcpLFxuICAgICAgdmFsaWRhdGVHbG9iYWxDb25maWcoKVxuICAgICk7XG4gICAgY29uc3QgbW9kZWwgPSBuZXcgY28yKHttb2RlbDogbWVyZ2VkVmFsaWRhdGVkQ29uZmlnLnR5cGV9KTtcblxuICAgIHJldHVybiBpbnB1dHMubWFwKGlucHV0ID0+IHtcbiAgICAgIGNvbnN0IG1lcmdlZFdpdGhDb25maWcgPSBPYmplY3QuYXNzaWduKFxuICAgICAgICB7fSxcbiAgICAgICAgdmFsaWRhdGVJbnB1dChpbnB1dCksXG4gICAgICAgIG1lcmdlZFZhbGlkYXRlZENvbmZpZ1xuICAgICAgKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdEJ5UGFyYW1zKG1lcmdlZFdpdGhDb25maWcsIG1vZGVsKTtcblxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgICA/IHtcbiAgICAgICAgICAgIC4uLmlucHV0LFxuICAgICAgICAgICAgJ2NhcmJvbi1vcGVyYXRpb25hbCc6IHJlc3VsdCxcbiAgICAgICAgICB9XG4gICAgICAgIDogaW5wdXQ7XG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZXMgYSByZXN1bHQgYmFzZWQgb24gdGhlIHByb3ZpZGVkIHN0YXRpYyBwYXJhbWV0ZXJzIHR5cGUuXG4gICAqL1xuICBjb25zdCBjYWxjdWxhdGVSZXN1bHRCeVBhcmFtcyA9IChcbiAgICBpbnB1dFdpdGhDb25maWc6IFBsdWdpblBhcmFtcyxcbiAgICBtb2RlbDogYW55XG4gICkgPT4ge1xuICAgIGNvbnN0IGdyZWVuaG9zdGluZyA9IGlucHV0V2l0aENvbmZpZ1snZ3JlZW4td2ViLWhvc3QnXSA9PT0gdHJ1ZTtcbiAgICBjb25zdCBvcHRpb25zID0gaW5wdXRXaXRoQ29uZmlnWydvcHRpb25zJ107XG4gICAgY29uc3QgR0JpbkJ5dGVzID0gaW5wdXRXaXRoQ29uZmlnWyduZXR3b3JrL2RhdGEnXSAqIDEwMDAgKiAxMDAwICogMTAwMDtcbiAgICBjb25zdCBieXRlcyA9IGlucHV0V2l0aENvbmZpZ1snbmV0d29yay9kYXRhL2J5dGVzJ10gfHwgR0JpbkJ5dGVzO1xuXG4gICAgY29uc3QgcGFyYW1UeXBlOiB7W2tleTogc3RyaW5nXTogKCkgPT4gc3RyaW5nfSA9IHtcbiAgICAgIHN3ZDogKCkgPT4ge1xuICAgICAgICByZXR1cm4gb3B0aW9uc1xuICAgICAgICAgID8gbW9kZWwucGVyVmlzaXRUcmFjZShieXRlcywgZ3JlZW5ob3N0aW5nLCBvcHRpb25zKS5jbzJcbiAgICAgICAgICA6IG1vZGVsLnBlclZpc2l0KGJ5dGVzLCBncmVlbmhvc3RpbmcpO1xuICAgICAgfSxcbiAgICAgICcxYnl0ZSc6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIG1vZGVsLnBlckJ5dGUoYnl0ZXMsIGdyZWVuaG9zdGluZyk7XG4gICAgICB9LFxuICAgIH07XG5cbiAgICByZXR1cm4gcGFyYW1UeXBlW2lucHV0V2l0aENvbmZpZy50eXBlXSgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgaW5wdXQgcGFyYW1ldGVycy5cbiAgICovXG4gIGNvbnN0IHZhbGlkYXRlSW5wdXQgPSAoaW5wdXQ6IFBsdWdpblBhcmFtcykgPT4ge1xuICAgIGNvbnN0IHNjaGVtYSA9IHpcbiAgICAgIC5vYmplY3Qoe1xuICAgICAgICAnbmV0d29yay9kYXRhL2J5dGVzJzogei5udW1iZXIoKSxcbiAgICAgICAgJ25ldHdvcmsvZGF0YSc6IHoubnVtYmVyKCksXG4gICAgICB9KVxuICAgICAgLnBhcnRpYWwoKVxuICAgICAgLnJlZmluZShkYXRhID0+ICEhZGF0YVsnbmV0d29yay9kYXRhL2J5dGVzJ10gfHwgISFkYXRhWyduZXR3b3JrL2RhdGEnXSwge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdFaXRoZXIgYG5ldHdvcmsvZGF0YS9ieXRlc2Agb3IgYG5ldHdvcmsvZGF0YWAgc2hvdWxkIGJlIHByb3ZpZGVkIGluIHRoZSBpbnB1dC4nLFxuICAgICAgfSk7XG5cbiAgICByZXR1cm4gdmFsaWRhdGU8ei5pbmZlcjx0eXBlb2Ygc2NoZW1hPj4oc2NoZW1hLCBpbnB1dCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyBHbG9iYWwgY29uZmlnIHBhcmFtZXRlcnMuXG4gICAqL1xuICBjb25zdCB2YWxpZGF0ZUdsb2JhbENvbmZpZyA9ICgpID0+IHtcbiAgICBjb25zdCBzY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICBvcHRpb25zOiB6XG4gICAgICAgIC5vYmplY3Qoe1xuICAgICAgICAgIGRhdGFSZWxvYWRSYXRpbzogei5udW1iZXIoKS5taW4oMCkubWF4KDEpLm9wdGlvbmFsKCksXG4gICAgICAgICAgZmlyc3RWaXNpdFBlcmNlbnRhZ2U6IHoubnVtYmVyKCkubWluKDApLm1heCgxKS5vcHRpb25hbCgpLFxuICAgICAgICAgIHJldHVyblZpc2l0UGVyY2VudGFnZTogei5udW1iZXIoKS5taW4oMCkubWF4KDEpLm9wdGlvbmFsKCksXG4gICAgICAgICAgZ3JpZEludGVuc2l0eTogelxuICAgICAgICAgICAgLm9iamVjdCh7XG4gICAgICAgICAgICAgIGRldmljZTogelxuICAgICAgICAgICAgICAgIC5udW1iZXIoKVxuICAgICAgICAgICAgICAgIC5vcih6Lm9iamVjdCh7Y291bnRyeTogei5zdHJpbmcoKX0pKVxuICAgICAgICAgICAgICAgIC5vcHRpb25hbCgpLFxuICAgICAgICAgICAgICBkYXRhQ2VudGVyOiB6XG4gICAgICAgICAgICAgICAgLm51bWJlcigpXG4gICAgICAgICAgICAgICAgLm9yKHoub2JqZWN0KHtjb3VudHJ5OiB6LnN0cmluZygpfSkpXG4gICAgICAgICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgICAgICAgIG5ldHdvcmtzOiB6XG4gICAgICAgICAgICAgICAgLm51bWJlcigpXG4gICAgICAgICAgICAgICAgLm9yKHoub2JqZWN0KHtjb3VudHJ5OiB6LnN0cmluZygpfSkpXG4gICAgICAgICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb25hbCgpLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHZhbGlkYXRlPHouaW5mZXI8dHlwZW9mIHNjaGVtYT4+KHNjaGVtYSwgZ2xvYmFsQ29uZmlnIHx8IHt9KTtcbiAgfTtcblxuICAvKipcbiAgICogVmFsaWRhdGVzIG5vZGUgY29uZmlnIHBhcmFtZXRlcnMuXG4gICAqL1xuICBjb25zdCB2YWxpZGF0ZUNvbmZpZyA9IChjb25maWc/OiBDb25maWdQYXJhbXMpID0+IHtcbiAgICBpZiAoIWNvbmZpZykge1xuICAgICAgdGhyb3cgbmV3IElucHV0VmFsaWRhdGlvbkVycm9yKFxuICAgICAgICBlcnJvckJ1aWxkZXIoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdDb25maWcgaXMgbm90IHByb3ZpZGVkJyxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2NoZW1hID0gelxuICAgICAgLm9iamVjdCh7XG4gICAgICAgIHR5cGU6IHouZW51bShbJzFieXRlJywgJ3N3ZCddKSxcbiAgICAgICAgJ2dyZWVuLXdlYi1ob3N0Jzogei5ib29sZWFuKCksXG4gICAgICB9KVxuICAgICAgLnJlZmluZShhbGxEZWZpbmVkLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdgdHlwZWAgYW5kIGBncmVlbi13ZWItaG9zdGAgYXJlIG5vdCBwcm92aWRlZCBpbiBub2RlIGNvbmZpZycsXG4gICAgICB9KTtcblxuICAgIHJldHVybiB2YWxpZGF0ZTx6LmluZmVyPHR5cGVvZiBzY2hlbWE+PihzY2hlbWEsIGNvbmZpZyk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBtZXRhZGF0YSxcbiAgICBleGVjdXRlLFxuICB9O1xufTtcbiJdfQ==