"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AzureImporter = void 0;
const dotenv = require("dotenv");
const zod_1 = require("zod");
const validations_1 = require("../../util/validations");
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const azure_api_1 = require("./azure-api");
const config_1 = require("./config");
const { UnsupportedValueError, InputValidationError, ConfigValidationError } = errors_1.ERRORS;
const AzureImporter = () => {
    const metadata = { kind: 'execute' };
    const errorBuilder = (0, helpers_1.buildErrorMessage)(exports.AzureImporter.name);
    const azureAPI = new azure_api_1.AzureAPI();
    /**
     * Executes the model for a list of input parameters.
     */
    const execute = async (inputs, config) => {
        dotenv.config();
        const validatedConfig = validateConfig(config);
        let enrichedOutputsArray = [];
        for await (const input of inputs) {
            const mergedWithConfig = Object.assign({}, validateInput(input), validatedConfig);
            const azureInput = mapInputToAzureInputs(mergedWithConfig);
            const rawResults = await getVmUsage(azureInput);
            const rawMetadataResults = await getInstanceMetadata(azureInput.vmName, azureInput.resourceGroupName);
            mergedWithConfig['duration'] = calculateDurationPerInput(azureInput);
            enrichedOutputsArray = enrichOutputs(rawResults, rawMetadataResults, mergedWithConfig);
        }
        return enrichedOutputsArray.flat();
    };
    /**
     * Enriches the raw output and metadata results with additional information
     * and maps them to a new structure based on the PluginParams input.
     */
    const enrichOutputs = (rawResults, rawMetadataResults, input) => {
        return rawResults.timestamps.map((timestamp, index) => ({
            'cloud/vendor': 'azure',
            'cpu/utilization': rawResults.cpuUtilizations[index],
            'memory/available/GB': parseFloat(rawResults.memAvailable[index]) * 1e-9,
            'memory/used/GB': parseFloat(rawMetadataResults.totalMemoryGB) -
                parseFloat(rawResults.memAvailable[index]) * 1e-9,
            'memory/capacity/GB': rawMetadataResults.totalMemoryGB,
            'memory/utilization': ((parseFloat(rawMetadataResults.totalMemoryGB) -
                parseFloat(rawResults.memAvailable[index]) * 1e-9) /
                parseFloat(rawMetadataResults.totalMemoryGB)) *
                100,
            location: rawMetadataResults.location,
            'cloud/instance-type': rawMetadataResults.instanceType,
            ...input,
            timestamp,
        }));
    };
    /**
     * Maps PluginParams input to AzureInputs structure for Azure-specific queries.
     */
    const mapInputToAzureInputs = (input) => {
        return {
            aggregation: input['azure-observation-aggregation'],
            resourceGroupName: input['azure-resource-group'],
            vmName: input['azure-vm-name'],
            subscriptionId: input['azure-subscription-id'],
            timestamp: input['timestamp'],
            duration: input['duration'].toString(),
            window: input['azure-observation-window'],
            timespan: getTimeSpan(input['duration'], input['timestamp']),
            interval: getInterval(input['azure-observation-window']),
        };
    };
    const validateConfig = (config) => {
        if (!config) {
            throw new ConfigValidationError(errorBuilder({ message: 'Config must be provided.' }));
        }
        const schema = zod_1.z
            .object({
            'azure-observation-window': zod_1.z.string(),
            'azure-observation-aggregation': zod_1.z.string(),
            'azure-resource-group': zod_1.z.string(),
            'azure-vm-name': zod_1.z.string(),
            'azure-subscription-id': zod_1.z.string(),
        })
            .refine(validations_1.allDefined, {
            message: 'All parameters should be present.',
        });
        return (0, validations_1.validate)(schema, config);
    };
    /**
     * Checks for required fields in input.
     */
    const validateInput = (input) => {
        const schema = zod_1.z
            .object({
            timestamp: zod_1.z.string().datetime(),
            duration: zod_1.z.number(),
        })
            .refine(validations_1.allDefined);
        return (0, validations_1.validate)(schema, input);
    };
    /**
     * Retrieves virtual machine usage metrics from Azure based on the provided AzureInputs.
     */
    const getVmUsage = async (metricParams) => {
        const timestamps = [];
        const cpuUtils = [];
        const memAvailable = [];
        // Helper function to parse metric data and populate metricArray and timestamps.
        const parseMetrics = async (timeSeriesData, metricArray, metricName) => {
            for (const data of (await timeSeriesData) ?? []) {
                if (typeof data.average !== 'undefined') {
                    metricArray.push(data.average.toString());
                    if (metricName === 'cpuUtilizations') {
                        timestamps.push(data.timeStamp.toISOString());
                    }
                }
            }
        };
        parseMetrics(getCPUMetrics(metricParams), cpuUtils, 'cpuUtilizations');
        parseMetrics(getRawMetrics(metricParams), memAvailable, '');
        return { timestamps, cpuUtilizations: cpuUtils, memAvailable };
    };
    /**
     * Gets CPU metrics by calling monitor client.
     */
    const getCPUMetrics = async (metricParams) => {
        return azureAPI.getMetricsTimeseries(metricParams, 'Percentage CPU');
    };
    /**
     * Gets RAW metrics by calling monitor client.
     */
    const getRawMetrics = async (metricParams) => {
        return azureAPI.getMetricsTimeseries(metricParams, 'Available Memory Bytes');
    };
    /**
     * Takes manifest `timestamp` and `duration` and returns an Azure formatted `timespan` value.
     */
    const getTimeSpan = (duration, timestamp) => {
        const start = new Date(timestamp);
        const end = new Date(start.getTime() + duration * 1000);
        return `${start.toISOString()}/${end.toISOString()}`;
    };
    /**
     * Formats given `amountOfTime` according to given `unit`.
     * Throws error if given `unit` is not supported.
     */
    const timeUnitConverter = (amountOfTime, unit) => {
        const unitsMap = {
            seconds: 'The minimum unit of time for azure importer is minutes',
            minutes: `T${amountOfTime}M`,
            hours: `T${amountOfTime}H`,
            days: `${amountOfTime}D`,
            weeks: `${amountOfTime}W`,
            months: `${amountOfTime}M`,
            years: `${amountOfTime}Y`,
        };
        const matchedUnit = Object.keys(unitsMap).find(key => {
            return config_1.ALIASES_OF_UNITS[key].includes(unit && unit.toLowerCase());
        });
        if (!matchedUnit) {
            throw new UnsupportedValueError(errorBuilder({
                message: 'azure-observation-window parameter is malformed',
            }));
        }
        if (matchedUnit === 'seconds') {
            throw new InputValidationError(errorBuilder({ message: unitsMap[matchedUnit] }));
        }
        return unitsMap[matchedUnit];
    };
    /**
     * Takes granularity as e.g. "1 m", "1 hr" and translates into ISO8601 as expected by the azure API.
     */
    const getInterval = (window) => {
        const [amountOfTime, unit] = window.split(' ', 2);
        return `P${timeUnitConverter(parseFloat(amountOfTime), unit)}`;
    };
    /**
     * Caculates total memory based on data from ComputeManagementClient response.
     */
    const calculateTotalMemory = async (instanceType, location) => {
        const resourceSkusList = await azureAPI.getResourceSkus();
        const filteredMemData = resourceSkusList
            .filter(item => item.resourceType === 'virtualMachines')
            .filter(item => item.name === instanceType)
            .filter(item => item.locations !== undefined);
        const vmCapabilitiesData = filteredMemData
            .filter(item => item.locations !== undefined && item.locations[0] === location)
            .map(item => item.capabilities)[0];
        const totalMemory = vmCapabilitiesData?.find(item => item.name === 'MemoryGB');
        return totalMemory?.value || '';
    };
    /**
     * Gathers instance metadata.
     */
    const getInstanceMetadata = async (vmName, resourceGroupName) => {
        const vmData = await azureAPI.getVMDataByResourceGroupName(resourceGroupName);
        const [location, instanceType] = vmData
            .filter(item => item.name === vmName)
            .map(item => [
            item.location ?? 'unknown',
            item.hardwareProfile?.vmSize ?? 'unknown',
        ])[0];
        const totalMemoryGB = await calculateTotalMemory(instanceType, location);
        return { location, instanceType, totalMemoryGB };
    };
    /**
     * Calculates number of seconds covered by each individual input using `azure-time-window` value
     */
    const calculateDurationPerInput = (azureInputs) => {
        const [value, unit] = azureInputs.window.split(' ', 2);
        return parseFloat(value) * (config_1.TIME_UNITS_IN_SECONDS[unit.toLowerCase()] || 0);
    };
    return {
        metadata,
        execute,
    };
};
exports.AzureImporter = AzureImporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2F6dXJlLWltcG9ydGVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGlDQUFpQztBQUNqQyw2QkFBc0I7QUFLdEIsd0RBQTREO0FBQzVELGdEQUFxRDtBQUNyRCw4Q0FBeUM7QUFRekMsMkNBQXFDO0FBQ3JDLHFDQUFpRTtBQUVqRSxNQUFNLEVBQUMscUJBQXFCLEVBQUUsb0JBQW9CLEVBQUUscUJBQXFCLEVBQUMsR0FDeEUsZUFBTSxDQUFDO0FBRUYsTUFBTSxhQUFhLEdBQUcsR0FBb0IsRUFBRTtJQUNqRCxNQUFNLFFBQVEsR0FBRyxFQUFDLElBQUksRUFBRSxTQUFTLEVBQUMsQ0FBQztJQUNuQyxNQUFNLFlBQVksR0FBRyxJQUFBLDJCQUFpQixFQUFDLHFCQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxFQUFFLENBQUM7SUFFaEM7O09BRUc7SUFDSCxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsTUFBc0IsRUFBRSxNQUFxQixFQUFFLEVBQUU7UUFDdEUsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRWhCLE1BQU0sZUFBZSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQyxJQUFJLG9CQUFvQixHQUFtQixFQUFFLENBQUM7UUFFOUMsSUFBSSxLQUFLLEVBQUUsTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQ2hDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FDcEMsRUFBRSxFQUNGLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFDcEIsZUFBZSxDQUNoQixDQUFDO1lBQ0YsTUFBTSxVQUFVLEdBQUcscUJBQXFCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUMzRCxNQUFNLFVBQVUsR0FBRyxNQUFNLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNo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bSAnQGF6dXJlL2FybS1tb25pdG9yJztcbmltcG9ydCAqIGFzIGRvdGVudiBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IHt6fSBmcm9tICd6b2QnO1xuXG5pbXBvcnQge1BsdWdpbkludGVyZmFjZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge0NvbmZpZ1BhcmFtcywgUGx1Z2luUGFyYW1zfSBmcm9tICcuLi8uLi90eXBlcy9jb21tb24nO1xuXG5pbXBvcnQge2FsbERlZmluZWQsIHZhbGlkYXRlfSBmcm9tICcuLi8uLi91dGlsL3ZhbGlkYXRpb25zJztcbmltcG9ydCB7YnVpbGRFcnJvck1lc3NhZ2V9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycyc7XG5pbXBvcnQge0VSUk9SU30gZnJvbSAnLi4vLi4vdXRpbC9lcnJvcnMnO1xuXG5pbXBvcnQge1xuICBBenVyZUlucHV0cyxcbiAgQXp1cmVPdXRwdXRzLFxuICBHZXRNZXRyaWNzUGFyYW1zLFxuICBBenVyZU1ldGFkYXRhT3V0cHV0cyxcbn0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQge0F6dXJlQVBJfSBmcm9tICcuL2F6dXJlLWFwaSc7XG5pbXBvcnQge0FMSUFTRVNfT0ZfVU5JVFMsIFRJTUVfVU5JVFNfSU5fU0VDT05EU30gZnJvbSAnLi9jb25maWcnO1xuXG5jb25zdCB7VW5zdXBwb3J0ZWRWYWx1ZUVycm9yLCBJbnB1dFZhbGlkYXRpb25FcnJvciwgQ29uZmlnVmFsaWRhdGlvbkVycm9yfSA9XG4gIEVSUk9SUztcblxuZXhwb3J0IGNvbnN0IEF6dXJlSW1wb3J0ZXIgPSAoKTogUGx1Z2luSW50ZXJmYWNlID0+IHtcbiAgY29uc3QgbWV0YWRhdGEgPSB7a2luZDogJ2V4ZWN1dGUnfTtcbiAgY29uc3QgZXJyb3JCdWlsZGVyID0gYnVpbGRFcnJvck1lc3NhZ2UoQXp1cmVJbXBvcnRlci5uYW1lKTtcbiAgY29uc3QgYXp1cmVBUEkgPSBuZXcgQXp1cmVBUEkoKTtcblxuICAvKipcbiAgICogRXhlY3V0ZXMgdGhlIG1vZGVsIGZvciBhIGxpc3Qgb2YgaW5wdXQgcGFyYW1ldGVycy5cbiAgICovXG4gIGNvbnN0IGV4ZWN1dGUgPSBhc3luYyAoaW5wdXRzOiBQbHVnaW5QYXJhbXNbXSwgY29uZmlnPzogQ29uZmlnUGFyYW1zKSA9PiB7XG4gICAgZG90ZW52LmNvbmZpZygpO1xuXG4gICAgY29uc3QgdmFsaWRhdGVkQ29uZmlnID0gdmFsaWRhdGVDb25maWcoY29uZmlnKTtcbiAgICBsZXQgZW5yaWNoZWRPdXRwdXRzQXJyYXk6IFBsdWdpblBhcmFtc1tdID0gW107XG5cbiAgICBmb3IgYXdhaXQgKGNvbnN0IGlucHV0IG9mIGlucHV0cykge1xuICAgICAgY29uc3QgbWVyZ2VkV2l0aENvbmZpZyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICAgIHt9LFxuICAgICAgICB2YWxpZGF0ZUlucHV0KGlucHV0KSxcbiAgICAgICAgdmFsaWRhdGVkQ29uZmlnXG4gICAgICApO1xuICAgICAgY29uc3QgYXp1cmVJbnB1dCA9IG1hcElucHV0VG9BenVyZUlucHV0cyhtZXJnZWRXaXRoQ29uZmlnKTtcbiAgICAgIGNvbnN0IHJhd1Jlc3VsdHMgPSBhd2FpdCBnZXRWbVVzYWdlKGF6dXJlSW5wdXQpO1xuICAgICAgY29uc3QgcmF3TWV0YWRhdGFSZXN1bHRzID0gYXdhaXQgZ2V0SW5zdGFuY2VNZXRhZGF0YShcbiAgICAgICAgYXp1cmVJbnB1dC52bU5hbWUsXG4gICAgICAgIGF6dXJlSW5wdXQucmVzb3VyY2VHcm91cE5hbWVcbiAgICAgICk7XG4gICAgICBtZXJnZWRXaXRoQ29uZmlnWydkdXJhdGlvbiddID0gY2FsY3VsYXRlRHVyYXRpb25QZXJJbnB1dChhenVyZUlucHV0KTtcblxuICAgICAgZW5yaWNoZWRPdXRwdXRzQXJyYXkgPSBlbnJpY2hPdXRwdXRzKFxuICAgICAgICByYXdSZXN1bHRzLFxuICAgICAgICByYXdNZXRhZGF0YVJlc3VsdHMsXG4gICAgICAgIG1lcmdlZFdpdGhDb25maWdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVucmljaGVkT3V0cHV0c0FycmF5LmZsYXQoKTtcbiAgfTtcblxuICAvKipcbiAgICogRW5yaWNoZXMgdGhlIHJhdyBvdXRwdXQgYW5kIG1ldGFkYXRhIHJlc3VsdHMgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4gICAqIGFuZCBtYXBzIHRoZW0gdG8gYSBuZXcgc3RydWN0dXJlIGJhc2VkIG9uIHRoZSBQbHVnaW5QYXJhbXMgaW5wdXQuXG4gICAqL1xuICBjb25zdCBlbnJpY2hPdXRwdXRzID0gKFxuICAgIHJhd1Jlc3VsdHM6IEF6dXJlT3V0cHV0cyxcbiAgICByYXdNZXRhZGF0YVJlc3VsdHM6IEF6dXJlTWV0YWRhdGFPdXRwdXRzLFxuICAgIGlucHV0OiBQbHVnaW5QYXJhbXNcbiAgKSA9PiB7XG4gICAgcmV0dXJuIHJhd1Jlc3VsdHMudGltZXN0YW1wcy5tYXAoKHRpbWVzdGFtcCwgaW5kZXgpID0+ICh7XG4gICAgICAnY2xvdWQvdmVuZG9yJzogJ2F6dXJlJyxcbiAgICAgICdjcHUvdXRpbGl6YXRpb24nOiByYXdSZXN1bHRzLmNwdVV0aWxpemF0aW9uc1tpbmRleF0sXG4gICAgICAnbWVtb3J5L2F2YWlsYWJsZS9HQic6IHBhcnNlRmxvYXQocmF3UmVzdWx0cy5tZW1BdmFpbGFibGVbaW5kZXhdKSAqIDFlLTksXG4gICAgICAnbWVtb3J5L3VzZWQvR0InOlxuICAgICAgICBwYXJzZUZsb2F0KHJhd01ldGFkYXRhUmVzdWx0cy50b3RhbE1lbW9yeUdCKSAtXG4gICAgICAgIHBhcnNlRmxvYXQocmF3UmVzdWx0cy5tZW1BdmFpbGFibGVbaW5kZXhdKSAqIDFlLTksXG4gICAgICAnbWVtb3J5L2NhcGFjaXR5L0dCJzogcmF3TWV0YWRhdGFSZXN1bHRzLnRvdGFsTWVtb3J5R0IsXG4gICAgICAnbWVtb3J5L3V0aWxpemF0aW9uJzpcbiAgICAgICAgKChwYXJzZUZsb2F0KHJhd01ldGFkYXRhUmVzdWx0cy50b3RhbE1lbW9yeUdCKSAtXG4gICAgICAgICAgcGFyc2VGbG9hdChyYXdSZXN1bHRzLm1lbUF2YWlsYWJsZVtpbmRleF0pICogMWUtOSkgL1xuICAgICAgICAgIHBhcnNlRmxvYXQocmF3TWV0YWRhdGFSZXN1bHRzLnRvdGFsTWVtb3J5R0IpKSAqXG4gICAgICAgIDEwMCxcbiAgICAgIGxvY2F0aW9uOiByYXdNZXRhZGF0YVJlc3VsdHMubG9jYXRpb24sXG4gICAgICAnY2xvdWQvaW5zdGFuY2UtdHlwZSc6IHJhd01ldGFkYXRhUmVzdWx0cy5pbnN0YW5jZVR5cGUsXG4gICAgICAuLi5pbnB1dCxcbiAgICAgIHRpbWVzdGFtcCxcbiAgICB9KSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIE1hcHMgUGx1Z2luUGFyYW1zIGlucHV0IHRvIEF6dXJlSW5wdXRzIHN0cnVjdHVyZSBmb3IgQXp1cmUtc3BlY2lmaWMgcXVlcmllcy5cbiAgICovXG4gIGNvbnN0IG1hcElucHV0VG9BenVyZUlucHV0cyA9IChpbnB1dDogUGx1Z2luUGFyYW1zKTogQXp1cmVJbnB1dHMgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBhZ2dyZWdhdGlvbjogaW5wdXRbJ2F6dXJlLW9ic2VydmF0aW9uLWFnZ3JlZ2F0aW9uJ10sXG4gICAgICByZXNvdXJjZUdyb3VwTmFtZTogaW5wdXRbJ2F6dXJlLXJlc291cmNlLWdyb3VwJ10sXG4gICAgICB2bU5hbWU6IGlucHV0WydhenVyZS12bS1uYW1lJ10sXG4gICAgICBzdWJzY3JpcHRpb25JZDogaW5wdXRbJ2F6dXJlLXN1YnNjcmlwdGlvbi1pZCddLFxuICAgICAgdGltZXN0YW1wOiBpbnB1dFsndGltZXN0YW1wJ10hLFxuICAgICAgZHVyYXRpb246IGlucHV0WydkdXJhdGlvbiddLnRvU3RyaW5nKCksXG4gICAgICB3aW5kb3c6IGlucHV0WydhenVyZS1vYnNlcnZhdGlvbi13aW5kb3cnXSxcbiAgICAgIHRpbWVzcGFuOiBnZXRUaW1lU3BhbihpbnB1dFsnZHVyYXRpb24nXSwgaW5wdXRbJ3RpbWVzdGFtcCddISksXG4gICAgICBpbnRlcnZhbDogZ2V0SW50ZXJ2YWwoaW5wdXRbJ2F6dXJlLW9ic2VydmF0aW9uLXdpbmRvdyddKSxcbiAgICB9O1xuICB9O1xuXG4gIGNvbnN0IHZhbGlkYXRlQ29uZmlnID0gKGNvbmZpZz86IENvbmZpZ1BhcmFtcykgPT4ge1xuICAgIGlmICghY29uZmlnKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmlnVmFsaWRhdGlvbkVycm9yKFxuICAgICAgICBlcnJvckJ1aWxkZXIoe21lc3NhZ2U6ICdDb25maWcgbXVzdCBiZSBwcm92aWRlZC4nfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2NoZW1hID0gelxuICAgICAgLm9iamVjdCh7XG4gICAgICAgICdhenVyZS1vYnNlcnZhdGlvbi13aW5kb3cnOiB6LnN0cmluZygpLFxuICAgICAgICAnYXp1cmUtb2JzZXJ2YXRpb24tYWdncmVnYXRpb24nOiB6LnN0cmluZygpLFxuICAgICAgICAnYXp1cmUtcmVzb3VyY2UtZ3JvdXAnOiB6LnN0cmluZygpLFxuICAgICAgICAnYXp1cmUtdm0tbmFtZSc6IHouc3RyaW5nKCksXG4gICAgICAgICdhenVyZS1zdWJzY3JpcHRpb24taWQnOiB6LnN0cmluZygpLFxuICAgICAgfSlcbiAgICAgIC5yZWZpbmUoYWxsRGVmaW5lZCwge1xuICAgICAgICBtZXNzYWdlOiAnQWxsIHBhcmFtZXRlcnMgc2hvdWxkIGJlIHByZXNlbnQuJyxcbiAgICAgIH0pO1xuXG4gICAgcmV0dXJuIHZhbGlkYXRlPHouaW5mZXI8dHlwZW9mIHNjaGVtYT4+KHNjaGVtYSwgY29uZmlnKTtcbiAgfTtcblxuICAvKipcbiAgICogQ2hlY2tzIGZvciByZXF1aXJlZCBmaWVsZHMgaW4gaW5wdXQuXG4gICAqL1xuICBjb25zdCB2YWxpZGF0ZUlucHV0ID0gKGlucHV0OiBQbHVnaW5QYXJhbXMpID0+IHtcbiAgICBjb25zdCBzY2hlbWEgPSB6XG4gICAgICAub2JqZWN0KHtcbiAgICAgICAgdGltZXN0YW1wOiB6LnN0cmluZygpLmRhdGV0aW1lKCksXG4gICAgICAgIGR1cmF0aW9uOiB6Lm51bWJlcigpLFxuICAgICAgfSlcbiAgICAgIC5yZWZpbmUoYWxsRGVmaW5lZCk7XG5cbiAgICByZXR1cm4gdmFsaWRhdGU8ei5pbmZlcjx0eXBlb2Ygc2NoZW1hPj4oc2NoZW1hLCBpbnB1dCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyB2aXJ0dWFsIG1hY2hpbmUgdXNhZ2UgbWV0cmljcyBmcm9tIEF6dXJlIGJhc2VkIG9uIHRoZSBwcm92aWRlZCBBenVyZUlucHV0cy5cbiAgICovXG4gIGNvbnN0IGdldFZtVXNhZ2UgPSBhc3luYyAoXG4gICAgbWV0cmljUGFyYW1zOiBBenVyZUlucHV0c1xuICApOiBQcm9taXNlPEF6dXJlT3V0cHV0cz4gPT4ge1xuICAgIGNvbnN0IHRpbWVzdGFtcHM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgY3B1VXRpbHM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgbWVtQXZhaWxhYmxlOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIHBhcnNlIG1ldHJpYyBkYXRhIGFuZCBwb3B1bGF0ZSBtZXRyaWNBcnJheSBhbmQgdGltZXN0YW1wcy5cbiAgICBjb25zdCBwYXJzZU1ldHJpY3MgPSBhc3luYyAoXG4gICAgICB0aW1lU2VyaWVzRGF0YTogUHJvbWlzZTxNZXRyaWNWYWx1ZVtdPixcbiAgICAgIG1ldHJpY0FycmF5OiBzdHJpbmdbXSxcbiAgICAgIG1ldHJpY05hbWU6IHN0cmluZ1xuICAgICkgPT4ge1xuICAgICAgZm9yIChjb25zdCBkYXRhIG9mIChhd2FpdCB0aW1lU2VyaWVzRGF0YSkgPz8gW10pIHtcbiAgICAgICAgaWYgKHR5cGVvZiBkYXRhLmF2ZXJhZ2UgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgbWV0cmljQXJyYXkucHVzaChkYXRhLmF2ZXJhZ2UudG9TdHJpbmcoKSk7XG4gICAgICAgICAgaWYgKG1ldHJpY05hbWUgPT09ICdjcHVVdGlsaXphdGlvbnMnKSB7XG4gICAgICAgICAgICB0aW1lc3RhbXBzLnB1c2goZGF0YS50aW1lU3RhbXAudG9JU09TdHJpbmcoKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIHBhcnNlTWV0cmljcyhnZXRDUFVNZXRyaWNzKG1ldHJpY1BhcmFtcyksIGNwdVV0aWxzLCAnY3B1VXRpbGl6YXRpb25zJyk7XG4gICAgcGFyc2VNZXRyaWNzKGdldFJhd01ldHJpY3MobWV0cmljUGFyYW1zKSwgbWVtQXZhaWxhYmxlLCAnJyk7XG5cbiAgICByZXR1cm4ge3RpbWVzdGFtcHMsIGNwdVV0aWxpemF0aW9uczogY3B1VXRpbHMsIG1lbUF2YWlsYWJsZX07XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldHMgQ1BVIG1ldHJpY3MgYnkgY2FsbGluZyBtb25pdG9yIGNsaWVudC5cbiAgICovXG4gIGNvbnN0IGdldENQVU1ldHJpY3MgPSBhc3luYyAobWV0cmljUGFyYW1zOiBHZXRNZXRyaWNzUGFyYW1zKSA9PiB7XG4gICAgcmV0dXJuIGF6dXJlQVBJLmdldE1ldHJpY3NUaW1lc2VyaWVzKG1ldHJpY1BhcmFtcywgJ1BlcmNlbnRhZ2UgQ1BVJyk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldHMgUkFXIG1ldHJpY3MgYnkgY2FsbGluZyBtb25pdG9yIGNsaWVudC5cbiAgICovXG4gIGNvbnN0IGdldFJhd01ldHJpY3MgPSBhc3luYyAobWV0cmljUGFyYW1zOiBHZXRNZXRyaWNzUGFyYW1zKSA9PiB7XG4gICAgcmV0dXJuIGF6dXJlQVBJLmdldE1ldHJpY3NUaW1lc2VyaWVzKFxuICAgICAgbWV0cmljUGFyYW1zLFxuICAgICAgJ0F2YWlsYWJsZSBNZW1vcnkgQnl0ZXMnXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogVGFrZXMgbWFuaWZlc3QgYHRpbWVzdGFtcGAgYW5kIGBkdXJhdGlvbmAgYW5kIHJldHVybnMgYW4gQXp1cmUgZm9ybWF0dGVkIGB0aW1lc3BhbmAgdmFsdWUuXG4gICAqL1xuICBjb25zdCBnZXRUaW1lU3BhbiA9IChkdXJhdGlvbjogbnVtYmVyLCB0aW1lc3RhbXA6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gICAgY29uc3Qgc3RhcnQgPSBuZXcgRGF0ZSh0aW1lc3RhbXApO1xuICAgIGNvbnN0IGVuZCA9IG5ldyBEYXRlKHN0YXJ0LmdldFRpbWUoKSArIGR1cmF0aW9uICogMTAwMCk7XG5cbiAgICByZXR1cm4gYCR7c3RhcnQudG9JU09TdHJpbmcoKX0vJHtlbmQudG9JU09TdHJpbmcoKX1gO1xuICB9O1xuXG4gIC8qKlxuICAgKiBGb3JtYXRzIGdpdmVuIGBhbW91bnRPZlRpbWVgIGFjY29yZGluZyB0byBnaXZlbiBgdW5pdGAuXG4gICAqIFRocm93cyBlcnJvciBpZiBnaXZlbiBgdW5pdGAgaXMgbm90IHN1cHBvcnRlZC5cbiAgICovXG4gIGNvbnN0IHRpbWVVbml0Q29udmVydGVyID0gKGFtb3VudE9mVGltZTogbnVtYmVyLCB1bml0OiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICAgIGNvbnN0IHVuaXRzTWFwOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfSA9IHtcbiAgICAgIHNlY29uZHM6ICdUaGUgbWluaW11bSB1bml0IG9mIHRpbWUgZm9yIGF6dXJlIGltcG9ydGVyIGlzIG1pbnV0ZXMnLFxuICAgICAgbWludXRlczogYFQke2Ftb3VudE9mVGltZX1NYCxcbiAgICAgIGhvdXJzOiBgVCR7YW1vdW50T2ZUaW1lfUhgLFxuICAgICAgZGF5czogYCR7YW1vdW50T2ZUaW1lfURgLFxuICAgICAgd2Vla3M6IGAke2Ftb3VudE9mVGltZX1XYCxcbiAgICAgIG1vbnRoczogYCR7YW1vdW50T2ZUaW1lfU1gLFxuICAgICAgeWVhcnM6IGAke2Ftb3VudE9mVGltZX1ZYCxcbiAgICB9O1xuXG4gICAgY29uc3QgbWF0Y2hlZFVuaXQgPSBPYmplY3Qua2V5cyh1bml0c01hcCkuZmluZChrZXkgPT4ge1xuICAgICAgcmV0dXJuIEFMSUFTRVNfT0ZfVU5JVFNba2V5XS5pbmNsdWRlcyh1bml0ICYmIHVuaXQudG9Mb3dlckNhc2UoKSk7XG4gICAgfSk7XG5cbiAgICBpZiAoIW1hdGNoZWRVbml0KSB7XG4gICAgICB0aHJvdyBuZXcgVW5zdXBwb3J0ZWRWYWx1ZUVycm9yKFxuICAgICAgICBlcnJvckJ1aWxkZXIoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdhenVyZS1vYnNlcnZhdGlvbi13aW5kb3cgcGFyYW1ldGVyIGlzIG1hbGZvcm1lZCcsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChtYXRjaGVkVW5pdCA9PT0gJ3NlY29uZHMnKSB7XG4gICAgICB0aHJvdyBuZXcgSW5wdXRWYWxpZGF0aW9uRXJyb3IoXG4gICAgICAgIGVycm9yQnVpbGRlcih7bWVzc2FnZTogdW5pdHNNYXBbbWF0Y2hlZFVuaXRdfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuaXRzTWFwW21hdGNoZWRVbml0XTtcbiAgfTtcblxuICAvKipcbiAgICogVGFrZXMgZ3JhbnVsYXJpdHkgYXMgZS5nLiBcIjEgbVwiLCBcIjEgaHJcIiBhbmQgdHJhbnNsYXRlcyBpbnRvIElTTzg2MDEgYXMgZXhwZWN0ZWQgYnkgdGhlIGF6dXJlIEFQSS5cbiAgICovXG4gIGNvbnN0IGdldEludGVydmFsID0gKHdpbmRvdzogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgICBjb25zdCBbYW1vdW50T2ZUaW1lLCB1bml0XSA9IHdpbmRvdy5zcGxpdCgnICcsIDIpO1xuICAgIHJldHVybiBgUCR7dGltZVVuaXRDb252ZXJ0ZXIocGFyc2VGbG9hdChhbW91bnRPZlRpbWUpLCB1bml0KX1gO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDYWN1bGF0ZXMgdG90YWwgbWVtb3J5IGJhc2VkIG9uIGRhdGEgZnJvbSBDb21wdXRlTWFuYWdlbWVudENsaWVudCByZXNwb25zZS5cbiAgICovXG4gIGNvbnN0IGNhbGN1bGF0ZVRvdGFsTWVtb3J5ID0gYXN5bmMgKFxuICAgIGluc3RhbmNlVHlwZTogc3RyaW5nLFxuICAgIGxvY2F0aW9uOiBzdHJpbmdcbiAgKSA9PiB7XG4gICAgY29uc3QgcmVzb3VyY2VTa3VzTGlzdCA9IGF3YWl0IGF6dXJlQVBJLmdldFJlc291cmNlU2t1cygpO1xuXG4gICAgY29uc3QgZmlsdGVyZWRNZW1EYXRhID0gcmVzb3VyY2VTa3VzTGlzdFxuICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0ucmVzb3VyY2VUeXBlID09PSAndmlydHVhbE1hY2hpbmVzJylcbiAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWUgPT09IGluc3RhbmNlVHlwZSlcbiAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLmxvY2F0aW9ucyAhPT0gdW5kZWZpbmVkKTtcblxuICAgIGNvbnN0IHZtQ2FwYWJpbGl0aWVzRGF0YSA9IGZpbHRlcmVkTWVtRGF0YVxuICAgICAgLmZpbHRlcihcbiAgICAgICAgaXRlbSA9PiBpdGVtLmxvY2F0aW9ucyAhPT0gdW5kZWZpbmVkICYmIGl0ZW0ubG9jYXRpb25zWzBdID09PSBsb2NhdGlvblxuICAgICAgKVxuICAgICAgLm1hcChpdGVtID0+IGl0ZW0uY2FwYWJpbGl0aWVzKVswXTtcblxuICAgIGNvbnN0IHRvdGFsTWVtb3J5ID0gdm1DYXBhYmlsaXRpZXNEYXRhPy5maW5kKFxuICAgICAgaXRlbSA9PiBpdGVtLm5hbWUgPT09ICdNZW1vcnlHQidcbiAgICApO1xuXG4gICAgcmV0dXJuIHRvdGFsTWVtb3J5Py52YWx1ZSB8fCAnJztcbiAgfTtcblxuICAvKipcbiAgICogR2F0aGVycyBpbnN0YW5jZSBtZXRhZGF0YS5cbiAgICovXG4gIGNvbnN0IGdldEluc3RhbmNlTWV0YWRhdGEgPSBhc3luYyAoXG4gICAgdm1OYW1lOiBzdHJpbmcsXG4gICAgcmVzb3VyY2VHcm91cE5hbWU6IHN0cmluZ1xuICApOiBQcm9taXNlPEF6dXJlTWV0YWRhdGFPdXRwdXRzPiA9PiB7XG4gICAgY29uc3Qgdm1EYXRhID1cbiAgICAgIGF3YWl0IGF6dXJlQVBJLmdldFZNRGF0YUJ5UmVzb3VyY2VHcm91cE5hbWUocmVzb3VyY2VHcm91cE5hbWUpO1xuICAgIGNvbnN0IFtsb2NhdGlvbiwgaW5zdGFuY2VUeXBlXSA9IHZtRGF0YVxuICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0ubmFtZSA9PT0gdm1OYW1lKVxuICAgICAgLm1hcChpdGVtID0+IFtcbiAgICAgICAgaXRlbS5sb2NhdGlvbiA/PyAndW5rbm93bicsXG4gICAgICAgIGl0ZW0uaGFyZHdhcmVQcm9maWxlPy52bVNpemUgPz8gJ3Vua25vd24nLFxuICAgICAgXSlbMF07XG5cbiAgICBjb25zdCB0b3RhbE1lbW9yeUdCID0gYXdhaXQgY2FsY3VsYXRlVG90YWxNZW1vcnkoaW5zdGFuY2VUeXBlLCBsb2NhdGlvbik7XG5cbiAgICByZXR1cm4ge2xvY2F0aW9uLCBpbnN0YW5jZVR5cGUsIHRvdGFsTWVtb3J5R0J9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGVzIG51bWJlciBvZiBzZWNvbmRzIGNvdmVyZWQgYnkgZWFjaCBpbmRpdmlkdWFsIGlucHV0IHVzaW5nIGBhenVyZS10aW1lLXdpbmRvd2AgdmFsdWVcbiAgICovXG4gIGNvbnN0IGNhbGN1bGF0ZUR1cmF0aW9uUGVySW5wdXQgPSAoYXp1cmVJbnB1dHM6IEF6dXJlSW5wdXRzKTogbnVtYmVyID0+IHtcbiAgICBjb25zdCBbdmFsdWUsIHVuaXRdID0gYXp1cmVJbnB1dHMud2luZG93LnNwbGl0KCcgJywgMik7XG5cbiAgICByZXR1cm4gcGFyc2VGbG9hdCh2YWx1ZSkgKiAoVElNRV9VTklUU19JTl9TRUNPTkRTW3VuaXQudG9Mb3dlckNhc2UoKV0gfHwgMCk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBtZXRhZGF0YSxcbiAgICBleGVjdXRlLFxuICB9O1xufTtcbiJdfQ==