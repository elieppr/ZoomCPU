"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TdpFinder = void 0;
const fs = require("fs");
const path = require("path");
const zod_1 = require("zod");
const validations_1 = require("../../util/validations");
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const { UnsupportedValueError, ReadFileError } = errors_1.ERRORS;
const TdpFinder = () => {
    const errorBuilder = (0, helpers_1.buildErrorMessage)(exports.TdpFinder.name);
    const metadata = {
        kind: 'execute',
    };
    /**
     * Calculate the total emissions for a list of inputs.
     */
    const execute = async (inputs) => {
        const data = await loadData();
        return inputs.map((input, index) => {
            const safeInput = Object.assign({}, input, validateInput(input));
            const processors = safeInput['physical-processor']
                .split(',')
                .map(processor => processor.trim());
            for (const processor of processors) {
                if (!(processor in data)) {
                    throw new UnsupportedValueError(errorBuilder({
                        message: `'physical-processor': ${processor} from input[${index}] is not found in the database`,
                    }));
                }
                safeInput['cpu/thermal-design-power'] = Math.max(safeInput['cpu/thermal-design-power'] ?? 0, data[processor]);
            }
            return safeInput;
        });
    };
    /**
     * Load data from csv files.
     */
    const loadData = async () => {
        const files = ['data.csv', 'data2.csv', 'boavizta-data.csv'];
        const combinedData = await files.reduce(async (accPromise, filePath) => {
            const acc = await accPromise;
            const lines = await readFile(filePath);
            return lines.reduce((dataAcc, line) => {
                const [name_w_at, tdp_r] = line.split(',');
                if (name_w_at === '') {
                    return dataAcc; // Skip processing empty lines
                }
                const name = name_w_at.split('@')[0].trim();
                const tdp = parseFloat(tdp_r.replace('\r', ''));
                if (!(name in dataAcc) || dataAcc[name] < tdp) {
                    dataAcc[name] = tdp;
                }
                return dataAcc;
            }, acc);
        }, Promise.resolve({}));
        return combinedData;
    };
    /**
     * Read the file with provided filePath.
     */
    const readFile = async (filePath) => {
        try {
            const result = await fs.promises.readFile(path.join(__dirname, filePath), 'utf8');
            return result.split('\n');
        }
        catch (error) {
            throw new ReadFileError(`Error reading file ${filePath}: ${error}`);
        }
    };
    /**
     * Checks for required fields in input.
     */
    const validateInput = (input) => {
        const schema = zod_1.z
            .object({
            'physical-processor': zod_1.z.string(),
        })
            .refine(validations_1.allDefined, {
            message: '`physical-processor` should be present.',
        });
        return (0, validations_1.validate)(schema, input);
    };
    return {
        metadata,
        execute,
    };
};
exports.TdpFinder = TdpFinder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3RkcC1maW5kZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUU3Qiw2QkFBc0I7QUFLdEIsd0RBQTREO0FBQzVELGdEQUFxRDtBQUNyRCw4Q0FBeUM7QUFFekMsTUFBTSxFQUFDLHFCQUFxQixFQUFFLGFBQWEsRUFBQyxHQUFHLGVBQU0sQ0FBQztBQUUvQyxNQUFNLFNBQVMsR0FBRyxHQUFvQixFQUFFO0lBQzdDLE1BQU0sWUFBWSxHQUFHLElBQUEsMkJBQWlCLEVBQUMsaUJBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2RCxNQUFNLFFBQVEsR0FBRztRQUNmLElBQUksRUFBRSxTQUFTO0tBQ2hCLENBQUM7SUFFRjs7T0FFRztJQUNILE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxNQUFzQixFQUFFLEVBQUU7UUFDL0MsTUFBTSxJQUFJLEdBQUcsTUFBTSxRQUFRLEVBQUUsQ0FBQztRQUU5QixPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDekMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQztpQkFDL0MsS0FBSyxDQUFDLEdBQUcsQ0FBQztpQkFDVixHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUV0QyxLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRSxDQUFDO2dCQUNuQyxJQUFJLENBQUMsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQztvQkFDekIsTUFBTSxJQUFJLHFC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QyxDQUFDO1FBRUwsT0FBTyxJQUFBLHNCQUFRLEVBQXlCLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN6RCxDQUFDLENBQUM7SUFFRixPQUFPO1FBQ0wsUUFBUTtRQUNSLE9BQU87S0FDUixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBekdXLFFBQUEsU0FBUyxhQXlHcEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQge3p9IGZyb20gJ3pvZCc7XG5cbmltcG9ydCB7UGx1Z2luSW50ZXJmYWNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7UGx1Z2luUGFyYW1zfSBmcm9tICcuLi8uLi90eXBlcy9jb21tb24nO1xuXG5pbXBvcnQge3ZhbGlkYXRlLCBhbGxEZWZpbmVkfSBmcm9tICcuLi8uLi91dGlsL3ZhbGlkYXRpb25zJztcbmltcG9ydCB7YnVpbGRFcnJvck1lc3NhZ2V9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycyc7XG5pbXBvcnQge0VSUk9SU30gZnJvbSAnLi4vLi4vdXRpbC9lcnJvcnMnO1xuXG5jb25zdCB7VW5zdXBwb3J0ZWRWYWx1ZUVycm9yLCBSZWFkRmlsZUVycm9yfSA9IEVSUk9SUztcblxuZXhwb3J0IGNvbnN0IFRkcEZpbmRlciA9ICgpOiBQbHVnaW5JbnRlcmZhY2UgPT4ge1xuICBjb25zdCBlcnJvckJ1aWxkZXIgPSBidWlsZEVycm9yTWVzc2FnZShUZHBGaW5kZXIubmFtZSk7XG4gIGNvbnN0IG1ldGFkYXRhID0ge1xuICAgIGtpbmQ6ICdleGVjdXRlJyxcbiAgfTtcblxuICAvKipcbiAgICogQ2FsY3VsYXRlIHRoZSB0b3RhbCBlbWlzc2lvbnMgZm9yIGEgbGlzdCBvZiBpbnB1dHMuXG4gICAqL1xuICBjb25zdCBleGVjdXRlID0gYXN5bmMgKGlucHV0czogUGx1Z2luUGFyYW1zW10pID0+IHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgbG9hZERhdGEoKTtcblxuICAgIHJldHVybiBpbnB1dHMubWFwKChpbnB1dCwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgY29uc3Qgc2FmZUlucHV0ID0gT2JqZWN0LmFzc2lnbih7fSwgaW5wdXQsIHZhbGlkYXRlSW5wdXQoaW5wdXQpKTtcbiAgICAgIGNvbnN0IHByb2Nlc3NvcnMgPSBzYWZlSW5wdXRbJ3BoeXNpY2FsLXByb2Nlc3NvciddXG4gICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgIC5tYXAocHJvY2Vzc29yID0+IHByb2Nlc3Nvci50cmltKCkpO1xuXG4gICAgICBmb3IgKGNvbnN0IHByb2Nlc3NvciBvZiBwcm9jZXNzb3JzKSB7XG4gICAgICAgIGlmICghKHByb2Nlc3NvciBpbiBkYXRhKSkge1xuICAgICAgICAgIHRocm93IG5ldyBVbnN1cHBvcnRlZFZhbHVlRXJyb3IoXG4gICAgICAgICAgICBlcnJvckJ1aWxkZXIoe1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgJ3BoeXNpY2FsLXByb2Nlc3Nvcic6ICR7cHJvY2Vzc29yfSBmcm9tIGlucHV0WyR7aW5kZXh9XSBpcyBub3QgZm91bmQgaW4gdGhlIGRhdGFiYXNlYCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHNhZmVJbnB1dFsnY3B1L3RoZXJtYWwtZGVzaWduLXBvd2VyJ10gPSBNYXRoLm1heChcbiAgICAgICAgICBzYWZlSW5wdXRbJ2NwdS90aGVybWFsLWRlc2lnbi1wb3dlciddID8/IDAsXG4gICAgICAgICAgZGF0YVtwcm9jZXNzb3JdXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzYWZlSW5wdXQ7XG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIExvYWQgZGF0YSBmcm9tIGNzdiBmaWxlcy5cbiAgICovXG4gIGNvbnN0IGxvYWREYXRhID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGZpbGVzID0gWydkYXRhLmNzdicsICdkYXRhMi5jc3YnLCAnYm9hdml6dGEtZGF0YS5jc3YnXTtcblxuICAgIGNvbnN0IGNvbWJpbmVkRGF0YSA9IGF3YWl0IGZpbGVzLnJlZHVjZShcbiAgICAgIGFzeW5jIChhY2NQcm9taXNlLCBmaWxlUGF0aCkgPT4ge1xuICAgICAgICBjb25zdCBhY2MgPSBhd2FpdCBhY2NQcm9taXNlO1xuICAgICAgICBjb25zdCBsaW5lcyA9IGF3YWl0IHJlYWRGaWxlKGZpbGVQYXRoKTtcblxuICAgICAgICByZXR1cm4gbGluZXMucmVkdWNlKChkYXRhQWNjLCBsaW5lKSA9PiB7XG4gICAgICAgICAgY29uc3QgW25hbWVfd19hdCwgdGRwX3JdID0gbGluZS5zcGxpdCgnLCcpO1xuXG4gICAgICAgICAgaWYgKG5hbWVfd19hdCA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhQWNjOyAvLyBTa2lwIHByb2Nlc3NpbmcgZW1wdHkgbGluZXNcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBuYW1lID0gbmFtZV93X2F0LnNwbGl0KCdAJylbMF0udHJpbSgpO1xuICAgICAgICAgIGNvbnN0IHRkcCA9IHBhcnNlRmxvYXQodGRwX3IucmVwbGFjZSgnXFxyJywgJycpKTtcblxuICAgICAgICAgIGlmICghKG5hbWUgaW4gZGF0YUFjYykgfHwgZGF0YUFjY1tuYW1lXSA8IHRkcCkge1xuICAgICAgICAgICAgZGF0YUFjY1tuYW1lXSA9IHRkcDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gZGF0YUFjYztcbiAgICAgICAgfSwgYWNjKTtcbiAgICAgIH0sXG4gICAgICBQcm9taXNlLnJlc29sdmUoe30gYXMge1tuYW1lOiBzdHJpbmddOiBudW1iZXJ9KVxuICAgICk7XG5cbiAgICByZXR1cm4gY29tYmluZWREYXRhO1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZWFkIHRoZSBmaWxlIHdpdGggcHJvdmlkZWQgZmlsZVBhdGguXG4gICAqL1xuICBjb25zdCByZWFkRmlsZSA9IGFzeW5jIChmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4gPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShcbiAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgZmlsZVBhdGgpLFxuICAgICAgICAndXRmOCdcbiAgICAgICk7XG4gICAgICByZXR1cm4gcmVzdWx0LnNwbGl0KCdcXG4nKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IFJlYWRGaWxlRXJyb3IoYEVycm9yIHJlYWRpbmcgZmlsZSAke2ZpbGVQYXRofTogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrcyBmb3IgcmVxdWlyZWQgZmllbGRzIGluIGlucHV0LlxuICAgKi9cbiAgY29uc3QgdmFsaWRhdGVJbnB1dCA9IChpbnB1dDogUGx1Z2luUGFyYW1zKSA9PiB7XG4gICAgY29uc3Qgc2NoZW1hID0gelxuICAgICAgLm9iamVjdCh7XG4gICAgICAgICdwaHlzaWNhbC1wcm9jZXNzb3InOiB6LnN0cmluZygpLFxuICAgICAgfSlcbiAgICAgIC5yZWZpbmUoYWxsRGVmaW5lZCwge1xuICAgICAgICBtZXNzYWdlOiAnYHBoeXNpY2FsLXByb2Nlc3NvcmAgc2hvdWxkIGJlIHByZXNlbnQuJyxcbiAgICAgIH0pO1xuXG4gICAgcmV0dXJuIHZhbGlkYXRlPHouaW5mZXI8dHlwZW9mIHNjaGVtYT4+KHNjaGVtYSwgaW5wdXQpO1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgbWV0YWRhdGEsXG4gICAgZXhlY3V0ZSxcbiAgfTtcbn07XG4iXX0=