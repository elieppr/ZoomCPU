"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockObservations = void 0;
const dayjs = require("dayjs");
const utc = require("dayjs/plugin/utc");
const timezone = require("dayjs/plugin/timezone");
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const common_generator_1 = require("./helpers/common-generator");
const rand_int_generator_1 = require("./helpers/rand-int-generator");
dayjs.extend(utc);
dayjs.extend(timezone);
const { InputValidationError } = errors_1.ERRORS;
const MockObservations = (globalConfig) => {
    const errorBuilder = (0, helpers_1.buildErrorMessage)('MockObservations');
    const metadata = {
        kind: 'execute',
    };
    /**
     * Generate sets of mocked observations based on config.
     */
    const execute = async (inputs) => {
        const { duration, timeBuckets, components, generators } = await generateParamsFromConfig();
        const generatorToHistory = new Map();
        generators.forEach(generator => {
            generatorToHistory.set(generator, []);
        });
        const defaults = inputs && inputs[0];
        return Object.entries(components).reduce((acc, [_key, component]) => {
            timeBuckets.forEach(timeBucket => {
                const observation = createObservation({ duration, component, timeBucket, generators }, generatorToHistory);
                acc.push(Object.assign(observation, defaults));
            });
            return acc;
        }, []);
    };
    /**
     * Configures the MockObservations Plugin for IF
     */
    const generateParamsFromConfig = async () => {
        const timestampFrom = dayjs.tz(getValidatedParam('timestamp-from', globalConfig), 'UTC');
        const timestampTo = dayjs.tz(getValidatedParam('timestamp-to', globalConfig), 'UTC');
        const duration = getValidatedParam('duration', globalConfig);
        return {
            duration,
            timeBuckets: createTimeBuckets(timestampFrom, timestampTo, duration),
            components: getValidatedParam('components', globalConfig),
            generators: createGenerators(getValidatedParam('generators', globalConfig)),
        };
    };
    /*
     * validate a parameter is included in a given parameters map.
     * return the validated param value, otherwise throw an InputValidationError.
     */
    const getValidatedParam = (paramName, params) => {
        if (!(paramName in params)) {
            throw new InputValidationError(errorBuilder({ message: `${paramName} missing from global config` }));
        }
        return params[paramName];
    };
    /*
     * create time buckets based on start time, end time and duration of each bucket.
     */
    const createTimeBuckets = (timestampFrom, timestampTo, duration, timeBuckets = []) => {
        if (timestampFrom.isBefore(timestampTo) ||
            timestampFrom.add(duration, 'second').isBefore(timestampTo)) {
            return createTimeBuckets(timestampFrom.add(duration, 'second'), timestampTo, duration, [...timeBuckets, timestampFrom]);
        }
        return timeBuckets;
    };
    /*
     * create generators based on a given config
     */
    const createGenerators = (generatorsConfig) => {
        const createCommonGenerator = (config) => [
            (0, common_generator_1.CommonGenerator)(config),
        ];
        const createRandIntGenerators = (config) => {
            return Object.entries(config).map(([fieldToPopulate, value]) => (0, rand_int_generator_1.RandIntGenerator)(fieldToPopulate, value));
        };
        return Object.entries(generatorsConfig).flatMap(([key, value]) => {
            if (key === 'common') {
                return createCommonGenerator(value);
            }
            else if (key === 'randint') {
                return createRandIntGenerators(value).flat();
            }
            return [];
        });
    };
    /*
     * Creates time buckets based on start time, end time and duration of each bucket.
     */
    const createObservation = (observationParams, generatorToHistory) => {
        const { duration, component, timeBucket, generators } = observationParams;
        const timestamp = timeBucket.toISOString();
        const generateObservation = (generator) => {
            const history = generatorToHistory.get(generator) || [];
            const generated = generator.next(history);
            generatorToHistory.set(generator, [...history, generated.value]);
            return generated;
        };
        const generateObservations = (gen) => generateObservation(gen);
        const generatedValues = generators.map(generateObservations);
        const initialObservation = {
            timestamp,
            duration,
            ...component,
        };
        const generatedObservation = generatedValues.reduce((observation, generated) => Object.assign(observation, generated), initialObservation);
        return generatedObservation;
    };
    return {
        metadata,
        execute,
    };
};
exports.MockObservations = MockObservations;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL21vY2stb2JzZXJ2YXRpb25zL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUErQjtBQUMvQix3Q0FBd0M7QUFDeEMsa0RBQWtEO0FBRWxELGdEQUFxRDtBQUNyRCw4Q0FBeUM7QUFLekMsaUVBQTJEO0FBQzNELHFFQUE4RDtBQUk5RCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2xCLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7QUFFdkIsTUFBTSxFQUFDLG9CQUFvQixFQUFDLEdBQUcsZUFBTSxDQUFDO0FBRS9CLE1BQU0sZ0JBQWdCLEdBQUcsQ0FDOUIsWUFBMEIsRUFDVCxFQUFFO0lBQ25CLE1BQU0sWUFBWSxHQUFHLElBQUEsMkJBQWlCLEVBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUMzRCxNQUFNLFFBQVEsR0FBRztRQUNmLElBQUksRUFBRSxTQUFTO0tBQ2hCLENBQUM7SUFFRjs7T0FFRztJQUNILE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxNQUFzQixFQUFFLEVBQUU7UUFDL0MsTUFBTSxFQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBQyxHQUNuRCxNQUFNLHdCQUF3QixFQUFFLENBQUM7UUFDbkMsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQztRQUUxRCxVQUFVLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQzdCLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXJDLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxN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LFNBQVMsQ0FBQztRQUNuQixDQUFDLENBQUM7UUFFRixNQUFNLG9CQUFvQixHQUFHLENBQUMsR0FBYyxFQUFFLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxRSxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDN0QsTUFBTSxrQkFBa0IsR0FBaUI7WUFDdkMsU0FBUztZQUNULFFBQVE7WUFDUixHQUFHLFNBQVM7U0FDYixDQUFDO1FBQ0YsTUFBTSxvQkFBb0IsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUNqRCxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxFQUNqRSxrQkFBa0IsQ0FDbkIsQ0FBQztRQUVGLE9BQU8sb0JBQW9DLENBQUM7SUFDOUMsQ0FBQyxDQUFDO0lBRUYsT0FBTztRQUNMLFFBQVE7UUFDUixPQUFPO0tBQ1IsQ0FBQztBQUNKLENBQUMsQ0FBQztBQXJLVyxRQUFBLGdCQUFnQixvQkFxSzNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZGF5anMgZnJvbSAnZGF5anMnO1xuaW1wb3J0ICogYXMgdXRjIGZyb20gJ2RheWpzL3BsdWdpbi91dGMnO1xuaW1wb3J0ICogYXMgdGltZXpvbmUgZnJvbSAnZGF5anMvcGx1Z2luL3RpbWV6b25lJztcblxuaW1wb3J0IHtidWlsZEVycm9yTWVzc2FnZX0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJztcbmltcG9ydCB7RVJST1JTfSBmcm9tICcuLi8uLi91dGlsL2Vycm9ycyc7XG5cbmltcG9ydCB7UGx1Z2luSW50ZXJmYWNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7Q29uZmlnUGFyYW1zLCBLZXlWYWx1ZVBhaXIsIFBsdWdpblBhcmFtc30gZnJvbSAnLi4vLi4vdHlwZXMvY29tbW9uJztcblxuaW1wb3J0IHtDb21tb25HZW5lcmF0b3J9IGZyb20gJy4vaGVscGVycy9jb21tb24tZ2VuZXJhdG9yJztcbmltcG9ydCB7UmFuZEludEdlbmVyYXRvcn0gZnJvbSAnLi9oZWxwZXJzL3JhbmQtaW50LWdlbmVyYXRvcic7XG5pbXBvcnQge0dlbmVyYXRvcn0gZnJvbSAnLi9pbnRlcmZhY2VzL2luZGV4JztcbmltcG9ydCB7T2JzZXJ2YXRpb25QYXJhbXN9IGZyb20gJy4vdHlwZXMnO1xuXG5kYXlqcy5leHRlbmQodXRjKTtcbmRheWpzLmV4dGVuZCh0aW1lem9uZSk7XG5cbmNvbnN0IHtJbnB1dFZhbGlkYXRpb25FcnJvcn0gPSBFUlJPUlM7XG5cbmV4cG9ydCBjb25zdCBNb2NrT2JzZXJ2YXRpb25zID0gKFxuICBnbG9iYWxDb25maWc6IENvbmZpZ1BhcmFtc1xuKTogUGx1Z2luSW50ZXJmYWNlID0+IHtcbiAgY29uc3QgZXJyb3JCdWlsZGVyID0gYnVpbGRFcnJvck1lc3NhZ2UoJ01vY2tPYnNlcnZhdGlvbnMnKTtcbiAgY29uc3QgbWV0YWRhdGEgPSB7XG4gICAga2luZDogJ2V4ZWN1dGUnLFxuICB9O1xuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBzZXRzIG9mIG1vY2tlZCBvYnNlcnZhdGlvbnMgYmFzZWQgb24gY29uZmlnLlxuICAgKi9cbiAgY29uc3QgZXhlY3V0ZSA9IGFzeW5jIChpbnB1dHM6IFBsdWdpblBhcmFtc1tdKSA9PiB7XG4gICAgY29uc3Qge2R1cmF0aW9uLCB0aW1lQnVja2V0cywgY29tcG9uZW50cywgZ2VuZXJhdG9yc30gPVxuICAgICAgYXdhaXQgZ2VuZXJhdGVQYXJhbXNGcm9tQ29uZmlnKCk7XG4gICAgY29uc3QgZ2VuZXJhdG9yVG9IaXN0b3J5ID0gbmV3IE1hcDxHZW5lcmF0b3IsIG51bWJlcltdPigpO1xuXG4gICAgZ2VuZXJhdG9ycy5mb3JFYWNoKGdlbmVyYXRvciA9PiB7XG4gICAgICBnZW5lcmF0b3JUb0hpc3Rvcnkuc2V0KGdlbmVyYXRvciwgW10pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZGVmYXVsdHMgPSBpbnB1dHMgJiYgaW5wdXRzWzBdO1xuXG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGNvbXBvbmVudHMpLnJlZHVjZShcbiAgICAgIChhY2M6IFBsdWdpblBhcmFtc1tdLCBbX2tleSwgY29tcG9uZW50XSkgPT4ge1xuICAgICAgICB0aW1lQnVja2V0cy5mb3JFYWNoKHRpbWVCdWNrZXQgPT4ge1xuICAgICAgICAgIGNvbnN0IG9ic2VydmF0aW9uID0gY3JlYXRlT2JzZXJ2YXRpb24oXG4gICAgICAgICAgICB7ZHVyYXRpb24sIGNvbXBvbmVudCwgdGltZUJ1Y2tldCwgZ2VuZXJhdG9yc30sXG4gICAgICAgICAgICBnZW5lcmF0b3JUb0hpc3RvcnlcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgYWNjLnB1c2goT2JqZWN0LmFzc2lnbihvYnNlcnZhdGlvbiwgZGVmYXVsdHMpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICBbXVxuICAgICk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbmZpZ3VyZXMgdGhlIE1vY2tPYnNlcnZhdGlvbnMgUGx1Z2luIGZvciBJRlxuICAgKi9cbiAgY29uc3QgZ2VuZXJhdGVQYXJhbXNGcm9tQ29uZmlnID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHRpbWVzdGFtcEZyb20gPSBkYXlqcy50eihcbiAgICAgIDxzdHJpbmc+Z2V0VmFsaWRhdGVkUGFyYW0oJ3RpbWVzdGFtcC1mcm9tJywgZ2xvYmFsQ29uZmlnKSxcbiAgICAgICdVVEMnXG4gICAgKTtcbiAgICBjb25zdCB0aW1lc3RhbXBUbyA9IGRheWpzLnR6KFxuICAgICAgPHN0cmluZz5nZXRWYWxpZGF0ZWRQYXJhbSgndGltZXN0YW1wLXRvJywgZ2xvYmFsQ29uZmlnKSxcbiAgICAgICdVVEMnXG4gICAgKTtcbiAgICBjb25zdCBkdXJhdGlvbiA9IDxudW1iZXI+Z2V0VmFsaWRhdGVkUGFyYW0oJ2R1cmF0aW9uJywgZ2xvYmFsQ29uZmlnKTtcblxuICAgIHJldHVybiB7XG4gICAgICBkdXJhdGlvbixcbiAgICAgIHRpbWVCdWNrZXRzOiBjcmVhdGVUaW1lQnVja2V0cyh0aW1lc3RhbXBGcm9tLCB0aW1lc3RhbXBUbywgZHVyYXRpb24pLFxuICAgICAgY29tcG9uZW50czogZ2V0VmFsaWRhdGVkUGFyYW0oJ2NvbXBvbmVudHMnLCBnbG9iYWxDb25maWcpIGFzIEtleVZhbHVlUGFpcixcbiAgICAgIGdlbmVyYXRvcnM6IGNyZWF0ZUdlbmVyYXRvcnMoXG4gICAgICAgIGdldFZhbGlkYXRlZFBhcmFtKCdnZW5lcmF0b3JzJywgZ2xvYmFsQ29uZmlnKVxuICAgICAgKSxcbiAgICB9O1xuICB9O1xuXG4gIC8qXG4gICAqIHZhbGlkYXRlIGEgcGFyYW1ldGVyIGlzIGluY2x1ZGVkIGluIGEgZ2l2ZW4gcGFyYW1ldGVycyBtYXAuXG4gICAqIHJldHVybiB0aGUgdmFsaWRhdGVkIHBhcmFtIHZhbHVlLCBvdGhlcndpc2UgdGhyb3cgYW4gSW5wdXRWYWxpZGF0aW9uRXJyb3IuXG4gICAqL1xuICBjb25zdCBnZXRWYWxpZGF0ZWRQYXJhbSA9IDxUPihcbiAgICBwYXJhbU5hbWU6IHN0cmluZyxcbiAgICBwYXJhbXM6IHtba2V5OiBzdHJpbmddOiBhbnl9XG4gICk6IFQgPT4ge1xuICAgIGlmICghKHBhcmFtTmFtZSBpbiBwYXJhbXMpKSB7XG4gICAgICB0aHJvdyBuZXcgSW5wdXRWYWxpZGF0aW9uRXJyb3IoXG4gICAgICAgIGVycm9yQnVpbGRlcih7bWVzc2FnZTogYCR7cGFyYW1OYW1lfSBtaXNzaW5nIGZyb20gZ2xvYmFsIGNvbmZpZ2B9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGFyYW1zW3BhcmFtTmFtZV07XG4gIH07XG5cbiAgLypcbiAgICogY3JlYXRlIHRpbWUgYnVja2V0cyBiYXNlZCBvbiBzdGFydCB0aW1lLCBlbmQgdGltZSBhbmQgZHVyYXRpb24gb2YgZWFjaCBidWNrZXQuXG4gICAqL1xuICBjb25zdCBjcmVhdGVUaW1lQnVja2V0cyA9IChcbiAgICB0aW1lc3RhbXBGcm9tOiBkYXlqcy5EYXlqcyxcbiAgICB0aW1lc3RhbXBUbzogZGF5anMuRGF5anMsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgICB0aW1lQnVja2V0czogZGF5anMuRGF5anNbXSA9IFtdXG4gICk6IGRheWpzLkRheWpzW10gPT4ge1xuICAgIGlmIChcbiAgICAgIHRpbWVzdGFtcEZyb20uaXNCZWZvcmUodGltZXN0YW1wVG8pIHx8XG4gICAgICB0aW1lc3RhbXBGcm9tLmFkZChkdXJhdGlvbiwgJ3NlY29uZCcpLmlzQmVmb3JlKHRpbWVzdGFtcFRvKVxuICAgICkge1xuICAgICAgcmV0dXJuIGNyZWF0ZVRpbWVCdWNrZXRzKFxuICAgICAgICB0aW1lc3RhbXBGcm9tLmFkZChkdXJhdGlvbiwgJ3NlY29uZCcpLFxuICAgICAgICB0aW1lc3RhbXBUbyxcbiAgICAgICAgZHVyYXRpb24sXG4gICAgICAgIFsuLi50aW1lQnVja2V0cywgdGltZXN0YW1wRnJvbV1cbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aW1lQnVja2V0cztcbiAgfTtcblxuICAvKlxuICAgKiBjcmVhdGUgZ2VuZXJhdG9ycyBiYXNlZCBvbiBhIGdpdmVuIGNvbmZpZ1xuICAgKi9cbiAgY29uc3QgY3JlYXRlR2VuZXJhdG9ycyA9IChnZW5lcmF0b3JzQ29uZmlnOiBvYmplY3QpOiBHZW5lcmF0b3JbXSA9PiB7XG4gICAgY29uc3QgY3JlYXRlQ29tbW9uR2VuZXJhdG9yID0gKGNvbmZpZzogYW55KTogR2VuZXJhdG9yW10gPT4gW1xuICAgICAgQ29tbW9uR2VuZXJhdG9yKGNvbmZpZyksXG4gICAgXTtcblxuICAgIGNvbnN0IGNyZWF0ZVJhbmRJbnRHZW5lcmF0b3JzID0gKGNvbmZpZzogYW55KTogR2VuZXJhdG9yW10gPT4ge1xuICAgICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGNvbmZpZykubWFwKChbZmllbGRUb1BvcHVsYXRlLCB2YWx1ZV0pID0+XG4gICAgICAgIFJhbmRJbnRHZW5lcmF0b3IoZmllbGRUb1BvcHVsYXRlLCB2YWx1ZSBhcyBLZXlWYWx1ZVBhaXIpXG4gICAgICApO1xuICAgIH07XG5cbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMoZ2VuZXJhdG9yc0NvbmZpZykuZmxhdE1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICBpZiAoa2V5ID09PSAnY29tbW9uJykge1xuICAgICAgICByZXR1cm4gY3JlYXRlQ29tbW9uR2VuZXJhdG9yKHZhbHVlKTtcbiAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAncmFuZGludCcpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZVJhbmRJbnRHZW5lcmF0b3JzKHZhbHVlKS5mbGF0KCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gW107XG4gICAgfSk7XG4gIH07XG5cbiAgLypcbiAgICogQ3JlYXRlcyB0aW1lIGJ1Y2tldHMgYmFzZWQgb24gc3RhcnQgdGltZSwgZW5kIHRpbWUgYW5kIGR1cmF0aW9uIG9mIGVhY2ggYnVja2V0LlxuICAgKi9cbiAgY29uc3QgY3JlYXRlT2JzZXJ2YXRpb24gPSAoXG4gICAgb2JzZXJ2YXRpb25QYXJhbXM6IE9ic2VydmF0aW9uUGFyYW1zLFxuICAgIGdlbmVyYXRvclRvSGlzdG9yeTogTWFwPEdlbmVyYXRvciwgbnVtYmVyW10+XG4gICk6IFBsdWdpblBhcmFtcyA9PiB7XG4gICAgY29uc3Qge2R1cmF0aW9uLCBjb21wb25lbnQsIHRpbWVCdWNrZXQsIGdlbmVyYXRvcnN9ID0gb2JzZXJ2YXRpb25QYXJhbXM7XG4gICAgY29uc3QgdGltZXN0YW1wID0gdGltZUJ1Y2tldC50b0lTT1N0cmluZygpO1xuXG4gICAgY29uc3QgZ2VuZXJhdGVPYnNlcnZhdGlvbiA9IChnZW5lcmF0b3I6IEdlbmVyYXRvcikgPT4ge1xuICAgICAgY29uc3QgaGlzdG9yeSA9IGdlbmVyYXRvclRvSGlzdG9yeS5nZXQoZ2VuZXJhdG9yKSB8fCBbXTtcbiAgICAgIGNvbnN0IGdlbmVyYXRlZDogUmVjb3JkPHN0cmluZywgYW55PiA9IGdlbmVyYXRvci5uZXh0KGhpc3RvcnkpO1xuXG4gICAgICBnZW5lcmF0b3JUb0hpc3Rvcnkuc2V0KGdlbmVyYXRvciwgWy4uLmhpc3RvcnksIGdlbmVyYXRlZC52YWx1ZV0pO1xuXG4gICAgICByZXR1cm4gZ2VuZXJhdGVkO1xuICAgIH07XG5cbiAgICBjb25zdCBnZW5lcmF0ZU9ic2VydmF0aW9ucyA9IChnZW46IEdlbmVyYXRvcikgPT4gZ2VuZXJhdGVPYnNlcnZhdGlvbihnZW4pO1xuICAgIGNvbnN0IGdlbmVyYXRlZFZhbHVlcyA9IGdlbmVyYXRvcnMubWFwKGdlbmVyYXRlT2JzZXJ2YXRpb25zKTtcbiAgICBjb25zdCBpbml0aWFsT2JzZXJ2YXRpb246IFBsdWdpblBhcmFtcyA9IHtcbiAgICAgIHRpbWVzdGFtcCxcbiAgICAgIGR1cmF0aW9uLFxuICAgICAgLi4uY29tcG9uZW50LFxuICAgIH07XG4gICAgY29uc3QgZ2VuZXJhdGVkT2JzZXJ2YXRpb24gPSBnZW5lcmF0ZWRWYWx1ZXMucmVkdWNlKFxuICAgICAgKG9ic2VydmF0aW9uLCBnZW5lcmF0ZWQpID0+IE9iamVjdC5hc3NpZ24ob2JzZXJ2YXRpb24sIGdlbmVyYXRlZCksXG4gICAgICBpbml0aWFsT2JzZXJ2YXRpb25cbiAgICApO1xuXG4gICAgcmV0dXJuIGdlbmVyYXRlZE9ic2VydmF0aW9uIGFzIFBsdWdpblBhcmFtcztcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIG1ldGFkYXRhLFxuICAgIGV4ZWN1dGUsXG4gIH07XG59O1xuIl19