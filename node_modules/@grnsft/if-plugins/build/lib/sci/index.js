"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Sci = void 0;
const zod_1 = require("zod");
const validations_1 = require("../../util/validations");
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const config_1 = require("./config");
const { InputValidationError } = errors_1.ERRORS;
const Sci = (globalConfig) => {
    const errorBuilder = (0, helpers_1.buildErrorMessage)(exports.Sci.name);
    const metadata = {
        kind: 'execute',
    };
    /**
     * Calculate the total emissions for a list of inputs.
     */
    const execute = async (inputs, config) => {
        const mergedConfig = Object.assign({}, globalConfig, config);
        const validatedConfigs = validateConfig(mergedConfig);
        return inputs.map(input => {
            const safeInput = validateInput(input);
            const inputWithConfigs = Object.assign({}, input, safeInput, validatedConfigs);
            return {
                ...input,
                ...tuneInput(inputWithConfigs),
            };
        });
    };
    /**
     * Given an input, tunes it and returns the tuned input.
     */
    const tuneInput = (input) => {
        const sciPerSecond = calculateSciSeconds(input);
        const factor = getFunctionalUnitConversionFactor(input);
        if (!input['functional-unit-time']) {
            return {
                carbon: input['carbon'] ?? sciPerSecond,
                sci: sciPerSecond / factor,
            };
        }
        const functionalUnitTime = parseTime(input);
        const sciTimed = convertSciToTimeUnit(sciPerSecond, functionalUnitTime);
        const sciTimedDuration = sciTimed * functionalUnitTime.value;
        return {
            carbon: input['carbon'] ?? sciPerSecond,
            sci: sciTimedDuration / factor,
        };
    };
    /**
     * Gets the conversion factor based on the functional unit specified in the input.
     * If the 'functional-unit' exists in the input and is not 'none' or an empty string,
     * returns the value; otherwise, defaults to 1.
     */
    const getFunctionalUnitConversionFactor = (input) => {
        const functionalUnit = input['functional-unit'];
        return functionalUnit in input &&
            input[functionalUnit] !== 'none' &&
            input[functionalUnit] !== ''
            ? input[functionalUnit]
            : 1;
    };
    /**
     * Converts the given sci value from seconds to the specified time unit.
     */
    const convertSciToTimeUnit = (sciPerSecond, functionalUnitTime) => {
        const conversionFactor = config_1.TIME_UNITS_IN_SECONDS[functionalUnitTime.unit];
        if (!conversionFactor) {
            throw new InputValidationError(errorBuilder({
                message: 'functional-unit-time is not in recognized unit of time',
            }));
        }
        return sciPerSecond * conversionFactor;
    };
    /**
     * Calculates sci in seconds for a given input.
     */
    const calculateSciSeconds = (input) => {
        const operational = parseFloat(input['carbon-operational']);
        const embodied = parseFloat(input['carbon-embodied']);
        const sciPerSecond = (operational + embodied) / input['duration'];
        return 'carbon' in input
            ? input['carbon'] / input['duration']
            : sciPerSecond;
    };
    /**
     * Validates node and gloabl configs.
     */
    const validateConfig = (config) => {
        const unitWarnMessage = 'Please ensure you have provided one value and one unit and they are either space, underscore, or hyphen separated.';
        const errorMessage = 'Either or both `functional-unit-time` and `functional-unit` should be provided';
        const schema = zod_1.z
            .object({
            'functional-unit-time': zod_1.z
                .string()
                .regex(new RegExp('^[0-9][ _-][a-zA-Z]+$'))
                .min(3, unitWarnMessage)
                .optional(),
            'functional-unit': zod_1.z.string().optional(),
        })
            .refine(data => data['functional-unit'] || data['functional-unit-time'], {
            message: errorMessage,
        });
        return (0, validations_1.validate)(schema, config);
    };
    /**
     * Checks for fields in input.
     */
    const validateInput = (input) => {
        const message = 'Either carbon or both of carbon-operational and carbon-embodied should be present.';
        const schemaWithCarbon = zod_1.z.object({
            carbon: zod_1.z.number().gte(0),
            duration: zod_1.z.number().gte(1),
        });
        const schemaWithoutCarbon = zod_1.z.object({
            'carbon-operational': zod_1.z.number().gte(0),
            'carbon-embodied': zod_1.z.number().gte(0),
            duration: zod_1.z.number().gte(1),
        });
        const schema = schemaWithCarbon
            .or(schemaWithoutCarbon)
            .refine(validations_1.allDefined, { message });
        return (0, validations_1.validate)(schema, input);
    };
    /**
     * Parses the 'functional-unit-time' from the input and extracts the time value and unit.
     * Updates the functionalUnitTime's unit and value properties accordingly.
     */
    const parseTime = (input) => {
        const splits = input['functional-unit-time'].split(/[-_ ]/);
        return {
            unit: splits[1],
            value: parseFloat(splits[0]),
        };
    };
    return {
        metadata,
        execute,
    };
};
exports.Sci = Sci;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3NjaS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2QkFBc0I7QUFLdEIsd0RBQTREO0FBQzVELGdEQUFxRDtBQUNyRCw4Q0FBeUM7QUFFekMscUNBQStDO0FBRS9DLE1BQU0sRUFBQyxvQkFBb0IsRUFBQyxHQUFHLGVBQU0sQ0FBQztBQUUvQixNQUFNLEdBQUcsR0FBRyxDQUFDLFlBQTJCLEVBQW1CLEVBQUU7SUFDbEUsTUFBTSxZQUFZLEdBQUcsSUFBQSwyQkFBaUIsRUFBQyxXQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsTUFBTSxRQUFRLEdBQUc7UUFDZixJQUFJLEVBQUUsU0FBUztLQUNoQixDQUFDO0lBRUY7O09BRUc7SUFDSCxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQ25CLE1BQXNCLEVBQ3RCLE1BQXFCLEVBQ0ksRUFBRTtRQUMzQixNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDN0QsTUFBTSxnQkFBZ0IsR0FBRyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFdEQsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hCLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQ3BDLEVBQUUsRUFDRixLQUFLLEVBQ0wsU0FBUyxFQUNULGdCQUFnQixDQUNqQixDQUFDO1lBRUYsT0FBTztnQkFDTCxHQUFHLEtBQUs7Z0JBQ1IsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUM7YUFDL0IsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxNQUFNLFNBQVMsR0FBRyxDQUFD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QUFPLElBQUEsc0JBQVEsRUFBeUIsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQztJQUVGOzs7T0FHRztJQUNILE1BQU0sU0FBUyxHQUFHLENBQUMsS0FBbUIsRUFBRSxFQUFFO1FBQ3hDLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1RCxPQUFPO1lBQ0wsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDZixLQUFLLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUM3QixDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUYsT0FBTztRQUNMLFFBQVE7UUFDUixPQUFPO0tBQ1IsQ0FBQztBQUNKLENBQUMsQ0FBQztBQTFLVyxRQUFBLEdBQUcsT0EwS2QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3p9IGZyb20gJ3pvZCc7XG5cbmltcG9ydCB7UGx1Z2luSW50ZXJmYWNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7Q29uZmlnUGFyYW1zLCBQbHVnaW5QYXJhbXN9IGZyb20gJy4uLy4uL3R5cGVzL2NvbW1vbic7XG5cbmltcG9ydCB7dmFsaWRhdGUsIGFsbERlZmluZWR9IGZyb20gJy4uLy4uL3V0aWwvdmFsaWRhdGlvbnMnO1xuaW1wb3J0IHtidWlsZEVycm9yTWVzc2FnZX0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJztcbmltcG9ydCB7RVJST1JTfSBmcm9tICcuLi8uLi91dGlsL2Vycm9ycyc7XG5cbmltcG9ydCB7VElNRV9VTklUU19JTl9TRUNPTkRTfSBmcm9tICcuL2NvbmZpZyc7XG5cbmNvbnN0IHtJbnB1dFZhbGlkYXRpb25FcnJvcn0gPSBFUlJPUlM7XG5cbmV4cG9ydCBjb25zdCBTY2kgPSAoZ2xvYmFsQ29uZmlnPzogQ29uZmlnUGFyYW1zKTogUGx1Z2luSW50ZXJmYWNlID0+IHtcbiAgY29uc3QgZXJyb3JCdWlsZGVyID0gYnVpbGRFcnJvck1lc3NhZ2UoU2NpLm5hbWUpO1xuICBjb25zdCBtZXRhZGF0YSA9IHtcbiAgICBraW5kOiAnZXhlY3V0ZScsXG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSB0aGUgdG90YWwgZW1pc3Npb25zIGZvciBhIGxpc3Qgb2YgaW5wdXRzLlxuICAgKi9cbiAgY29uc3QgZXhlY3V0ZSA9IGFzeW5jIChcbiAgICBpbnB1dHM6IFBsdWdpblBhcmFtc1tdLFxuICAgIGNvbmZpZz86IENvbmZpZ1BhcmFtc1xuICApOiBQcm9taXNlPFBsdWdpblBhcmFtc1tdPiA9PiB7XG4gICAgY29uc3QgbWVyZ2VkQ29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgZ2xvYmFsQ29uZmlnLCBjb25maWcpO1xuICAgIGNvbnN0IHZhbGlkYXRlZENvbmZpZ3MgPSB2YWxpZGF0ZUNvbmZpZyhtZXJnZWRDb25maWcpO1xuXG4gICAgcmV0dXJuIGlucHV0cy5tYXAoaW5wdXQgPT4ge1xuICAgICAgY29uc3Qgc2FmZUlucHV0ID0gdmFsaWRhdGVJbnB1dChpbnB1dCk7XG4gICAgICBjb25zdCBpbnB1dFdpdGhDb25maWdzID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAge30sXG4gICAgICAgIGlucHV0LFxuICAgICAgICBzYWZlSW5wdXQsXG4gICAgICAgIHZhbGlkYXRlZENvbmZpZ3NcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLmlucHV0LFxuICAgICAgICAuLi50dW5lSW5wdXQoaW5wdXRXaXRoQ29uZmlncyksXG4gICAgICB9O1xuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBHaXZlbiBhbiBpbnB1dCwgdHVuZXMgaXQgYW5kIHJldHVybnMgdGhlIHR1bmVkIGlucHV0LlxuICAgKi9cbiAgY29uc3QgdHVuZUlucHV0ID0gKGlucHV0OiBQbHVnaW5QYXJhbXMpID0+IHtcbiAgICBjb25zdCBzY2lQZXJTZWNvbmQgPSBjYWxjdWxhdGVTY2lTZWNvbmRzKGlucHV0KTtcbiAgICBjb25zdCBmYWN0b3IgPSBnZXRGdW5jdGlvbmFsVW5pdENvbnZlcnNpb25GYWN0b3IoaW5wdXQpO1xuXG4gICAgaWYgKCFpbnB1dFsnZnVuY3Rpb25hbC11bml0LXRpbWUnXSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY2FyYm9uOiBpbnB1dFsnY2FyYm9uJ10gPz8gc2NpUGVyU2Vjb25kLFxuICAgICAgICBzY2k6IHNjaVBlclNlY29uZCAvIGZhY3RvcixcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgZnVuY3Rpb25hbFVuaXRUaW1lID0gcGFyc2VUaW1lKGlucHV0KTtcbiAgICBjb25zdCBzY2lUaW1lZCA9IGNvbnZlcnRTY2lUb1RpbWVVbml0KHNjaVBlclNlY29uZCwgZnVuY3Rpb25hbFVuaXRUaW1lKTtcbiAgICBjb25zdCBzY2lUaW1lZER1cmF0aW9uID0gc2NpVGltZWQgKiBmdW5jdGlvbmFsVW5pdFRpbWUudmFsdWU7XG5cbiAgICByZXR1cm4ge1xuICAgICAgY2FyYm9uOiBpbnB1dFsnY2FyYm9uJ10gPz8gc2NpUGVyU2Vjb25kLFxuICAgICAgc2NpOiBzY2lUaW1lZER1cmF0aW9uIC8gZmFjdG9yLFxuICAgIH07XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGNvbnZlcnNpb24gZmFjdG9yIGJhc2VkIG9uIHRoZSBmdW5jdGlvbmFsIHVuaXQgc3BlY2lmaWVkIGluIHRoZSBpbnB1dC5cbiAgICogSWYgdGhlICdmdW5jdGlvbmFsLXVuaXQnIGV4aXN0cyBpbiB0aGUgaW5wdXQgYW5kIGlzIG5vdCAnbm9uZScgb3IgYW4gZW1wdHkgc3RyaW5nLFxuICAgKiByZXR1cm5zIHRoZSB2YWx1ZTsgb3RoZXJ3aXNlLCBkZWZhdWx0cyB0byAxLlxuICAgKi9cbiAgY29uc3QgZ2V0RnVuY3Rpb25hbFVuaXRDb252ZXJzaW9uRmFjdG9yID0gKGlucHV0OiBQbHVnaW5QYXJhbXMpOiBudW1iZXIgPT4ge1xuICAgIGNvbnN0IGZ1bmN0aW9uYWxVbml0ID0gaW5wdXRbJ2Z1bmN0aW9uYWwtdW5pdCddO1xuXG4gICAgcmV0dXJuIGZ1bmN0aW9uYWxVbml0IGluIGlucHV0ICYmXG4gICAgICBpbnB1dFtmdW5jdGlvbmFsVW5pdF0gIT09ICdub25lJyAmJlxuICAgICAgaW5wdXRbZnVuY3Rpb25hbFVuaXRdICE9PSAnJ1xuICAgICAgPyBpbnB1dFtmdW5jdGlvbmFsVW5pdF1cbiAgICAgIDogMTtcbiAgfTtcblxuICAvKipcbiAgICogQ29udmVydHMgdGhlIGdpdmVuIHNjaSB2YWx1ZSBmcm9tIHNlY29uZHMgdG8gdGhlIHNwZWNpZmllZCB0aW1lIHVuaXQuXG4gICAqL1xuICBjb25zdCBjb252ZXJ0U2NpVG9UaW1lVW5pdCA9IChcbiAgICBzY2lQZXJTZWNvbmQ6IG51bWJlcixcbiAgICBmdW5jdGlvbmFsVW5pdFRpbWU6IHt1bml0OiBzdHJpbmc7IHZhbHVlOiBudW1iZXJ9XG4gICk6IG51bWJlciA9PiB7XG4gICAgY29uc3QgY29udmVyc2lvbkZhY3RvciA9IFRJTUVfVU5JVFNfSU5fU0VDT05EU1tmdW5jdGlvbmFsVW5pdFRpbWUudW5pdF07XG5cbiAgICBpZiAoIWNvbnZlcnNpb25GYWN0b3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnB1dFZhbGlkYXRpb25FcnJvcihcbiAgICAgICAgZXJyb3JCdWlsZGVyKHtcbiAgICAgICAgICBtZXNzYWdlOiAnZnVuY3Rpb25hbC11bml0LXRpbWUgaXMgbm90IGluIHJlY29nbml6ZWQgdW5pdCBvZiB0aW1lJyxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNjaVBlclNlY29uZCAqIGNvbnZlcnNpb25GYWN0b3I7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZXMgc2NpIGluIHNlY29uZHMgZm9yIGEgZ2l2ZW4gaW5wdXQuXG4gICAqL1xuICBjb25zdCBjYWxjdWxhdGVTY2lTZWNvbmRzID0gKGlucHV0OiBQbHVnaW5QYXJhbXMpOiBudW1iZXIgPT4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbmFsID0gcGFyc2VGbG9hdChpbnB1dFsnY2FyYm9uLW9wZXJhdGlvbmFsJ10pO1xuICAgIGNvbnN0IGVtYm9kaWVkID0gcGFyc2VGbG9hdChpbnB1dFsnY2FyYm9uLWVtYm9kaWVkJ10pO1xuICAgIGNvbnN0IHNjaVBlclNlY29uZCA9IChvcGVyYXRpb25hbCArIGVtYm9kaWVkKSAvIGlucHV0WydkdXJhdGlvbiddO1xuXG4gICAgcmV0dXJuICdjYXJib24nIGluIGlucHV0XG4gICAgICA/IGlucHV0WydjYXJib24nXSAvIGlucHV0WydkdXJhdGlvbiddXG4gICAgICA6IHNjaVBlclNlY29uZDtcbiAgfTtcblxuICAvKipcbiAgICogVmFsaWRhdGVzIG5vZGUgYW5kIGdsb2FibCBjb25maWdzLlxuICAgKi9cbiAgY29uc3QgdmFsaWRhdGVDb25maWcgPSAoY29uZmlnOiBDb25maWdQYXJhbXMpID0+IHtcbiAgICBjb25zdCB1bml0V2Fybk1lc3NhZ2UgPVxuICAgICAgJ1BsZWFzZSBlbnN1cmUgeW91IGhhdmUgcHJvdmlkZWQgb25lIHZhbHVlIGFuZCBvbmUgdW5pdCBhbmQgdGhleSBhcmUgZWl0aGVyIHNwYWNlLCB1bmRlcnNjb3JlLCBvciBoeXBoZW4gc2VwYXJhdGVkLic7XG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID1cbiAgICAgICdFaXRoZXIgb3IgYm90aCBgZnVuY3Rpb25hbC11bml0LXRpbWVgIGFuZCBgZnVuY3Rpb25hbC11bml0YCBzaG91bGQgYmUgcHJvdmlkZWQnO1xuXG4gICAgY29uc3Qgc2NoZW1hID0gelxuICAgICAgLm9iamVjdCh7XG4gICAgICAgICdmdW5jdGlvbmFsLXVuaXQtdGltZSc6IHpcbiAgICAgICAgICAuc3RyaW5nKClcbiAgICAgICAgICAucmVnZXgobmV3IFJlZ0V4cCgnXlswLTldWyBfLV1bYS16QS1aXSskJykpXG4gICAgICAgICAgLm1pbigzLCB1bml0V2Fybk1lc3NhZ2UpXG4gICAgICAgICAgLm9wdGlvbmFsKCksXG4gICAgICAgICdmdW5jdGlvbmFsLXVuaXQnOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gICAgICB9KVxuICAgICAgLnJlZmluZShkYXRhID0+IGRhdGFbJ2Z1bmN0aW9uYWwtdW5pdCddIHx8IGRhdGFbJ2Z1bmN0aW9uYWwtdW5pdC10aW1lJ10sIHtcbiAgICAgICAgbWVzc2FnZTogZXJyb3JNZXNzYWdlLFxuICAgICAgfSk7XG5cbiAgICByZXR1cm4gdmFsaWRhdGU8ei5pbmZlcjx0eXBlb2Ygc2NoZW1hPj4oc2NoZW1hLCBjb25maWcpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDaGVja3MgZm9yIGZpZWxkcyBpbiBpbnB1dC5cbiAgICovXG4gIGNvbnN0IHZhbGlkYXRlSW5wdXQgPSAoaW5wdXQ6IFBsdWdpblBhcmFtcykgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgJ0VpdGhlciBjYXJib24gb3IgYm90aCBvZiBjYXJib24tb3BlcmF0aW9uYWwgYW5kIGNhcmJvbi1lbWJvZGllZCBzaG91bGQgYmUgcHJlc2VudC4nO1xuXG4gICAgY29uc3Qgc2NoZW1hV2l0aENhcmJvbiA9IHoub2JqZWN0KHtcbiAgICAgIGNhcmJvbjogei5udW1iZXIoKS5ndGUoMCksXG4gICAgICBkdXJhdGlvbjogei5udW1iZXIoKS5ndGUoMSksXG4gICAgfSk7XG5cbiAgICBjb25zdCBzY2hlbWFXaXRob3V0Q2FyYm9uID0gei5vYmplY3Qoe1xuICAgICAgJ2NhcmJvbi1vcGVyYXRpb25hbCc6IHoubnVtYmVyKCkuZ3RlKDApLFxuICAgICAgJ2NhcmJvbi1lbWJvZGllZCc6IHoubnVtYmVyKCkuZ3RlKDApLFxuICAgICAgZHVyYXRpb246IHoubnVtYmVyKCkuZ3RlKDEpLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2NoZW1hID0gc2NoZW1hV2l0aENhcmJvblxuICAgICAgLm9yKHNjaGVtYVdpdGhvdXRDYXJib24pXG4gICAgICAucmVmaW5lKGFsbERlZmluZWQsIHttZXNzYWdlfSk7XG5cbiAgICByZXR1cm4gdmFsaWRhdGU8ei5pbmZlcjx0eXBlb2Ygc2NoZW1hPj4oc2NoZW1hLCBpbnB1dCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFBhcnNlcyB0aGUgJ2Z1bmN0aW9uYWwtdW5pdC10aW1lJyBmcm9tIHRoZSBpbnB1dCBhbmQgZXh0cmFjdHMgdGhlIHRpbWUgdmFsdWUgYW5kIHVuaXQuXG4gICAqIFVwZGF0ZXMgdGhlIGZ1bmN0aW9uYWxVbml0VGltZSdzIHVuaXQgYW5kIHZhbHVlIHByb3BlcnRpZXMgYWNjb3JkaW5nbHkuXG4gICAqL1xuICBjb25zdCBwYXJzZVRpbWUgPSAoaW5wdXQ6IFBsdWdpblBhcmFtcykgPT4ge1xuICAgIGNvbnN0IHNwbGl0cyA9IGlucHV0WydmdW5jdGlvbmFsLXVuaXQtdGltZSddLnNwbGl0KC9bLV8gXS8pO1xuICAgIHJldHVybiB7XG4gICAgICB1bml0OiBzcGxpdHNbMV0sXG4gICAgICB2YWx1ZTogcGFyc2VGbG9hdChzcGxpdHNbMF0pLFxuICAgIH07XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBtZXRhZGF0YSxcbiAgICBleGVjdXRlLFxuICB9O1xufTtcbiJdfQ==