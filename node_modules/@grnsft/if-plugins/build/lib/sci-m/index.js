"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SciM = void 0;
const zod_1 = require("zod");
const validations_1 = require("../../util/validations");
const helpers_1 = require("../../util/helpers");
const errors_1 = require("../../util/errors");
const { InputValidationError } = errors_1.ERRORS;
const SciM = () => {
    const errorBuilder = (0, helpers_1.buildErrorMessage)(exports.SciM.name);
    const metadata = {
        kind: 'execute',
    };
    const METRICS = [
        'device/emissions-embodied',
        'device/expected-lifespan',
        'resources-reserved',
        'vcpus-allocated',
        'resources-total',
        'vcpus-total',
    ];
    /**
     * Calculate the Embodied carbon for a list of inputs.
     */
    const execute = async (inputs) => {
        return inputs.map(input => {
            const safeInput = validateInput(input);
            return {
                ...input,
                'carbon-embodied': calculateEmbodiedCarbon(safeInput),
            };
        });
    };
    /**
     * Calculate the Embodied carbon for the input.
     * M = totalEmissions * (duration/ExpectedLifespan) * (resourcesReserved/totalResources)
     */
    const calculateEmbodiedCarbon = (input) => {
        const totalEmissions = parseNumberInput(input['device/emissions-embodied'], 'gCO2e');
        const duration = parseNumberInput(input['duration'], 'seconds');
        const expectedLifespan = parseNumberInput(input['device/expected-lifespan'], 'seconds');
        const resourcesReserved = parseNumberInput(input['vcpus-allocated'] || input['resources-reserved'], 'count');
        const totalResources = parseNumberInput(input['vcpus-total'] || input['resources-total'], 'count');
        return (totalEmissions *
            (duration / expectedLifespan) *
            (resourcesReserved / totalResources));
    };
    /**
     * Parses the input value, ensuring it is a valid number, and returns the parsed number.
     * Throws an InputValidationError if the value is not a valid number.
     */
    const parseNumberInput = (value, unit) => {
        const parsedValue = typeof value === 'string' ? parseFloat(value) : value;
        if (typeof parsedValue !== 'number' || isNaN(parsedValue)) {
            throw new InputValidationError(errorBuilder({
                message: `'${value}' is not a valid number in input. Please provide it as ${unit}.`,
            }));
        }
        return parsedValue;
    };
    /**
     * Checks for required fields in input.
     */
    const validateInput = (input) => {
        const schemaWithVcpus = zod_1.z.object({
            'device/emissions-embodied': zod_1.z.number().gte(0).min(0),
            'device/expected-lifespan': zod_1.z.number().gte(0).min(0),
            'vcpus-allocated': zod_1.z.number().gte(0).min(0),
            'vcpus-total': zod_1.z.number().gte(0).min(0),
            duration: zod_1.z.number().gte(1),
        });
        const schemaWithResources = zod_1.z.object({
            'device/emissions-embodied': zod_1.z.number().gte(0).min(0),
            'device/expected-lifespan': zod_1.z.number().gte(0).min(0),
            'resources-reserved': zod_1.z.number().gte(0).min(0),
            'resources-total': zod_1.z.number().gte(0).min(0),
            duration: zod_1.z.number().gte(1),
        });
        const schema = schemaWithVcpus.or(schemaWithResources).refine(validations_1.allDefined, {
            message: `All ${METRICS} should be present.`,
        });
        return (0, validations_1.validate)(schema, input);
    };
    return {
        metadata,
        execute,
    };
};
exports.SciM = SciM;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3NjaS1tL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUFzQjtBQUt0Qix3REFBNEQ7QUFDNUQsZ0RBQXFEO0FBQ3JELDhDQUF5QztBQUV6QyxNQUFNLEVBQUMsb0JBQW9CLEVBQUMsR0FBRyxlQUFNLENBQUM7QUFFL0IsTUFBTSxJQUFJLEdBQUcsR0FBb0IsRUFBRTtJQUN4QyxNQUFNLFlBQVksR0FBRyxJQUFBLDJCQUFpQixFQUFDLFlBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRCxNQUFNLFFBQVEsR0FBRztRQUNmLElBQUksRUFBRSxTQUFTO0tBQ2hCLENBQUM7SUFDRixNQUFNLE9BQU8sR0FBRztRQUNkLDJCQUEyQjtRQUMzQiwwQkFBMEI7UUFDMUIsb0JBQW9CO1FBQ3BCLGlCQUFpQjtRQUNqQixpQkFBaUI7UUFDakIsYUFBYTtLQUNkLENBQUM7SUFFRjs7T0FFRztJQUNILE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxNQUFzQixFQUFFLEVBQUU7UUFDL0MsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hCLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUV2QyxPQUFPO2dCQUNMLEdBQUcsS0FBSztnQkFDUixpQkFBaUIsRUFBRSx1QkFBdUIsQ0FBQyxTQUFTLENBQUM7YUFDdEQsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0lBRUY7OztPQUdHO0lBQ0gsTUFBTSx1QkFBdUIsR0FBRyxDQUFDLEtBQW1CLEVBQUUsRUFBRTtRQUN0RCxNQUFNLGNBQWMsR0FBRyxnQkFBZ0IsQ0FDckMsS0FBSyxDQUFDLDJCQUEyQixDQUFDLEVBQ2xDLE9BQU8sQ0FDUixDQUFDO1FBQ0YsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFD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RUgsTUFBTSxNQUFNLEdBQUcsZUFBZSxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx3QkFBVSxFQUFFO1lBQ3hFLE9BQU8sRUFBRSxPQUFPLE9BQU8scUJBQXFCO1NBQzdDLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBQSxzQkFBUSxFQUF5QixNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekQsQ0FBQyxDQUFDO0lBRUYsT0FBTztRQUNMLFFBQVE7UUFDUixPQUFPO0tBQ1IsQ0FBQztBQUNKLENBQUMsQ0FBQztBQTNHVyxRQUFBLElBQUksUUEyR2YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3p9IGZyb20gJ3pvZCc7XG5cbmltcG9ydCB7UGx1Z2luSW50ZXJmYWNlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7UGx1Z2luUGFyYW1zfSBmcm9tICcuLi8uLi90eXBlcy9jb21tb24nO1xuXG5pbXBvcnQge3ZhbGlkYXRlLCBhbGxEZWZpbmVkfSBmcm9tICcuLi8uLi91dGlsL3ZhbGlkYXRpb25zJztcbmltcG9ydCB7YnVpbGRFcnJvck1lc3NhZ2V9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycyc7XG5pbXBvcnQge0VSUk9SU30gZnJvbSAnLi4vLi4vdXRpbC9lcnJvcnMnO1xuXG5jb25zdCB7SW5wdXRWYWxpZGF0aW9uRXJyb3J9ID0gRVJST1JTO1xuXG5leHBvcnQgY29uc3QgU2NpTSA9ICgpOiBQbHVnaW5JbnRlcmZhY2UgPT4ge1xuICBjb25zdCBlcnJvckJ1aWxkZXIgPSBidWlsZEVycm9yTWVzc2FnZShTY2lNLm5hbWUpO1xuICBjb25zdCBtZXRhZGF0YSA9IHtcbiAgICBraW5kOiAnZXhlY3V0ZScsXG4gIH07XG4gIGNvbnN0IE1FVFJJQ1MgPSBbXG4gICAgJ2RldmljZS9lbWlzc2lvbnMtZW1ib2RpZWQnLFxuICAgICdkZXZpY2UvZXhwZWN0ZWQtbGlmZXNwYW4nLFxuICAgICdyZXNvdXJjZXMtcmVzZXJ2ZWQnLFxuICAgICd2Y3B1cy1hbGxvY2F0ZWQnLFxuICAgICdyZXNvdXJjZXMtdG90YWwnLFxuICAgICd2Y3B1cy10b3RhbCcsXG4gIF07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSB0aGUgRW1ib2RpZWQgY2FyYm9uIGZvciBhIGxpc3Qgb2YgaW5wdXRzLlxuICAgKi9cbiAgY29uc3QgZXhlY3V0ZSA9IGFzeW5jIChpbnB1dHM6IFBsdWdpblBhcmFtc1tdKSA9PiB7XG4gICAgcmV0dXJuIGlucHV0cy5tYXAoaW5wdXQgPT4ge1xuICAgICAgY29uc3Qgc2FmZUlucHV0ID0gdmFsaWRhdGVJbnB1dChpbnB1dCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLmlucHV0LFxuICAgICAgICAnY2FyYm9uLWVtYm9kaWVkJzogY2FsY3VsYXRlRW1ib2RpZWRDYXJib24oc2FmZUlucHV0KSxcbiAgICAgIH07XG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSB0aGUgRW1ib2RpZWQgY2FyYm9uIGZvciB0aGUgaW5wdXQuXG4gICAqIE0gPSB0b3RhbEVtaXNzaW9ucyAqIChkdXJhdGlvbi9FeHBlY3RlZExpZmVzcGFuKSAqIChyZXNvdXJjZXNSZXNlcnZlZC90b3RhbFJlc291cmNlcylcbiAgICovXG4gIGNvbnN0IGNhbGN1bGF0ZUVtYm9kaWVkQ2FyYm9uID0gKGlucHV0OiBQbHVnaW5QYXJhbXMpID0+IHtcbiAgICBjb25zdCB0b3RhbEVtaXNzaW9ucyA9IHBhcnNlTnVtYmVySW5wdXQoXG4gICAgICBpbnB1dFsnZGV2aWNlL2VtaXNzaW9ucy1lbWJvZGllZCddLFxuICAgICAgJ2dDTzJlJ1xuICAgICk7XG4gICAgY29uc3QgZHVyYXRpb24gPSBwYXJzZU51bWJlcklucHV0KGlucHV0WydkdXJhdGlvbiddLCAnc2Vjb25kcycpO1xuICAgIGNvbnN0IGV4cGVjdGVkTGlmZXNwYW4gPSBwYXJzZU51bWJlcklucHV0KFxuICAgICAgaW5wdXRbJ2RldmljZS9leHBlY3RlZC1saWZlc3BhbiddLFxuICAgICAgJ3NlY29uZHMnXG4gICAgKTtcbiAgICBjb25zdCByZXNvdXJjZXNSZXNlcnZlZCA9IHBhcnNlTnVtYmVySW5wdXQoXG4gICAgICBpbnB1dFsndmNwdXMtYWxsb2NhdGVkJ10gfHwgaW5wdXRbJ3Jlc291cmNlcy1yZXNlcnZlZCddLFxuICAgICAgJ2NvdW50J1xuICAgICk7XG4gICAgY29uc3QgdG90YWxSZXNvdXJjZXMgPSBwYXJzZU51bWJlcklucHV0KFxuICAgICAgaW5wdXRbJ3ZjcHVzLXRvdGFsJ10gfHwgaW5wdXRbJ3Jlc291cmNlcy10b3RhbCddLFxuICAgICAgJ2NvdW50J1xuICAgICk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgdG90YWxFbWlzc2lvbnMgKlxuICAgICAgKGR1cmF0aW9uIC8gZXhwZWN0ZWRMaWZlc3BhbikgKlxuICAgICAgKHJlc291cmNlc1Jlc2VydmVkIC8gdG90YWxSZXNvdXJjZXMpXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogUGFyc2VzIHRoZSBpbnB1dCB2YWx1ZSwgZW5zdXJpbmcgaXQgaXMgYSB2YWxpZCBudW1iZXIsIGFuZCByZXR1cm5zIHRoZSBwYXJzZWQgbnVtYmVyLlxuICAgKiBUaHJvd3MgYW4gSW5wdXRWYWxpZGF0aW9uRXJyb3IgaWYgdGhlIHZhbHVlIGlzIG5vdCBhIHZhbGlkIG51bWJlci5cbiAgICovXG4gIGNvbnN0IHBhcnNlTnVtYmVySW5wdXQgPSAodmFsdWU6IGFueSwgdW5pdDogc3RyaW5nKTogbnVtYmVyID0+IHtcbiAgICBjb25zdCBwYXJzZWRWYWx1ZSA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUZsb2F0KHZhbHVlKSA6IHZhbHVlO1xuXG4gICAgaWYgKHR5cGVvZiBwYXJzZWRWYWx1ZSAhPT0gJ251bWJlcicgfHwgaXNOYU4ocGFyc2VkVmFsdWUpKSB7XG4gICAgICB0aHJvdyBuZXcgSW5wdXRWYWxpZGF0aW9uRXJyb3IoXG4gICAgICAgIGVycm9yQnVpbGRlcih7XG4gICAgICAgICAgbWVzc2FnZTogYCcke3ZhbHVlfScgaXMgbm90IGEgdmFsaWQgbnVtYmVyIGluIGlucHV0LiBQbGVhc2UgcHJvdmlkZSBpdCBhcyAke3VuaXR9LmAsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBwYXJzZWRWYWx1ZTtcbiAgfTtcblxuICAvKipcbiAgICogQ2hlY2tzIGZvciByZXF1aXJlZCBmaWVsZHMgaW4gaW5wdXQuXG4gICAqL1xuICBjb25zdCB2YWxpZGF0ZUlucHV0ID0gKGlucHV0OiBQbHVnaW5QYXJhbXMpID0+IHtcbiAgICBjb25zdCBzY2hlbWFXaXRoVmNwdXMgPSB6Lm9iamVjdCh7XG4gICAgICAnZGV2aWNlL2VtaXNzaW9ucy1lbWJvZGllZCc6IHoubnVtYmVyKCkuZ3RlKDApLm1pbigwKSxcbiAgICAgICdkZXZpY2UvZXhwZWN0ZWQtbGlmZXNwYW4nOiB6Lm51bWJlcigpLmd0ZSgwKS5taW4oMCksXG4gICAgICAndmNwdXMtYWxsb2NhdGVkJzogei5udW1iZXIoKS5ndGUoMCkubWluKDApLFxuICAgICAgJ3ZjcHVzLXRvdGFsJzogei5udW1iZXIoKS5ndGUoMCkubWluKDApLFxuICAgICAgZHVyYXRpb246IHoubnVtYmVyKCkuZ3RlKDEpLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2NoZW1hV2l0aFJlc291cmNlcyA9IHoub2JqZWN0KHtcbiAgICAgICdkZXZpY2UvZW1pc3Npb25zLWVtYm9kaWVkJzogei5udW1iZXIoKS5ndGUoMCkubWluKDApLFxuICAgICAgJ2RldmljZS9leHBlY3RlZC1saWZlc3Bhbic6IHoubnVtYmVyKCkuZ3RlKDApLm1pbigwKSxcbiAgICAgICdyZXNvdXJjZXMtcmVzZXJ2ZWQnOiB6Lm51bWJlcigpLmd0ZSgwKS5taW4oMCksXG4gICAgICAncmVzb3VyY2VzLXRvdGFsJzogei5udW1iZXIoKS5ndGUoMCkubWluKDApLFxuICAgICAgZHVyYXRpb246IHoubnVtYmVyKCkuZ3RlKDEpLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2NoZW1hID0gc2NoZW1hV2l0aFZjcHVzLm9yKHNjaGVtYVdpdGhSZXNvdXJjZXMpLnJlZmluZShhbGxEZWZpbmVkLCB7XG4gICAgICBtZXNzYWdlOiBgQWxsICR7TUVUUklDU30gc2hvdWxkIGJlIHByZXNlbnQuYCxcbiAgICB9KTtcblxuICAgIHJldHVybiB2YWxpZGF0ZTx6LmluZmVyPHR5cGVvZiBzY2hlbWE+PihzY2hlbWEsIGlucHV0KTtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIG1ldGFkYXRhLFxuICAgIGV4ZWN1dGUsXG4gIH07XG59O1xuIl19